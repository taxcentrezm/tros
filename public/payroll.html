 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAYROLL Management - SMAIT ERP</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            blue: '#3b82f6',
                            indigo: '#6366f1',
                            cyan: '#06b6d4',
                            emerald: '#10b981',
                            amber: '#f59e0b',
                            rose: '#f43f5e'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


</head>
<body class="bg-gray-50 font-sans antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 relative z-10">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-600 to-primary-800 rounded-lg flex items-center justify-center">
                        <i data-feather="grid" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-semibold text-primary-900">SMAIT ERP</span>
                </div>
                
                                <div class="hidden lg:flex space-x-1">
                    <a href="index.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Dashboard</a>
                    <a href="hr.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">HR</a>
                    <a href="inventory.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Inventory</a>
                    <a href="finance.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Finance</a>
                    <a href="sales.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Sales & CRM</a>
                    <a href="reports.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Reports</a>
                    <a href="payroll.html" class="px-4 py-2 text-primary-700 bg-primary-100 rounded-lg transition-colors font-medium">Payroll</a>
                    <a href="salaries.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Salaries</a>
                     <a href="loans.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Loans</a>
                     <a href="employee.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Employees</a>
                    <a href="fiscal.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Fiscal</a>
                </div>
</div>
</div>
</nav>

  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Payroll Summary â€“ November 2025</h1>
   


  <main class="container mx-auto px-4 py-12">
    <!-- Employee Input Form -->
    <section class="bg-white p-6 rounded-xl shadow mb-12">
  <form id="employeeForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12 bg-white p-6 rounded-xl shadow">
<select id="employee_id" class="w-full px-4 py-2 border rounded-lg">
  <option value="">-- Select Employee ID --</option>
</select>

<select id="full_name" class="w-full px-4 py-2 border rounded-lg">
  <option value="">-- Select Employee Name --</option>
</select>

<select id="tpin" class="w-full px-4 py-2 border rounded-lg">
  <option value="">-- Select Employee TPIN --</option>
</select>

<select id="nrc" class="w-full px-4 py-2 border rounded-lg">
  <option value="">-- Select Employee NRC --</option>
</select>
   <label for="periodSelect" class="block text-sm font-medium mb-1">Payroll Period</label>
<select id="periodSelect" class="w-full px-3 py-2 border rounded bg-white text-sm">
  <option value="">Select a period</option>
</select>
    <input type="text" id="department" placeholder="Department" class="px-4 py-2 border rounded" required />
    <input type="number" id="basicPay" placeholder="Basic Pay" class="px-4 py-2 border rounded" required />
    <input type="number" id="housingPay" placeholder="Housing Allowance" class="px-4 py-2 border rounded" />
    <input type="number" id="transportPay" placeholder="Transport Allowance" class="px-4 py-2 border rounded" />
    <input type="number" id="bonus" placeholder="Bonuses" class="px-4 py-2 border rounded" />
    <input type="number" id="loan" placeholder="Loan" class="px-4 py-2 border rounded" />
   <input type="date" id="effective_date" name="effective_date" required>


    <button type="submit" class="col-span-1 md:col-span-3 bg-blue-600 text-white px-4 py-2 rounded">
      Add Employee
    </button>
  </form>
</section>


    <!-- Quick Stats -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-600">Total Payroll</p>
            <h3 id="totalPayroll" class="text-3xl font-bold text-primary-800">K 0</h3>
          </div>
          <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
            <i data-feather="credit-card" class="text-primary-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-600">Average Salary</p>
            <h3 id="averageSalary" class="text-3xl font-bold text-primary-800">K 0</h3>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <i data-feather="bar-chart-2" class="text-green-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-600">PAYE Contributions</p>
            <h3 id="payeContributions" class="text-3xl font-bold text-primary-800">K 0</h3>
          </div>
          <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
            <i data-feather="file-text" class="text-orange-600"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-gray-600">Net Pay Distributed</p>
            <h3 id="netPayDistributed" class="text-3xl font-bold text-primary-800">K 0</h3>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <i data-feather="check-circle" class="text-blue-600"></i>
          </div>
        </div>
      </div>


    </section>

    <!-- Charts Section -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
  <!-- Deduction Chart -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-4">Deduction Breakdown</h2>
    <canvas id="deductionChart" class="w-full h-64"></canvas>
  </div>
  <!-- Salary Chart -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="text-lg font-semibold mb-4">Salary Distribution</h2>
    <canvas id="salaryChart" class="w-full h-64"></canvas>
  </div>
</section>

 
<section class="bg-white p-6 rounded-xl shadow mb-12">
  <h2 class="text-lg font-semibold mb-4">Employee Payroll Details</h2>
  <table class="w-full text-sm" id="employeeTable">
    <thead>
      <tr class="bg-gray-100 text-left">
        <th class="px-4 py-2">Name</th>
        <th class="px-4 py-2">Gross</th>
        <th class="px-4 py-2">Net</th>
        <th class="px-4 py-2">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Export Button -->
<button onclick="exportChartsToPDF()" class="bg-purple-600 text-white px-4 py-2 rounded">
  Export Charts to PDF
</button>

  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
feather && feather.replace();

// =============================
// Global State
// =============================
window.employees = [];         // from /api/hr/employees
window.payrollRecords = [];    // from /api/payroll/salaries
window.selectedEmployeeId = null;
window.deductionChart = null;
window.salaryChart = null;

// =============================
// DOM Helpers
// =============================
function $(id) { return document.getElementById(id); }
function clearSelect(sel) {
  if (!sel) return;
  while (sel.options.length > 1) sel.remove(1);
}

// =============================
// Payroll Periods
// =============================
async function populatePeriodDropdown() {
  try {
    const res = await fetch("/api/payroll/salaries");
    const json = await res.json();
    const periods = json.periods || [];

    const select = $("periodSelect");
    if (!select) return;
    select.innerHTML = `<option value="">Select a period</option>`;

    periods.forEach(p => {
      const label = `${p.period_year}-${String(p.period_month).padStart(2, "0")} (${p.start_date} to ${p.end_date})`;
      const opt = document.createElement("option");
      opt.value = p.period_id;
      opt.textContent = label;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("âŒ Failed to load periods:", err);
  }
}

// =============================
// Load Employees & Payroll Records
// =============================
async function loadEmployees() {
  try {
    const res = await fetch("/api/hr/employees");
    if (!res.ok) throw new Error("Failed to fetch employees");
    const json = await res.json();
    window.employees = json.data || [];
    populateEmployeeDropdowns();
  } catch (err) {
    console.error("âŒ Error loading employees:", err);
  }
}

async function loadPayrollRecords() {
  try {
    const res = await fetch("/api/payroll/salaries");
    if (!res.ok) throw new Error("Failed to fetch payroll records");
    const json = await res.json();
    window.payrollRecords = json.records || [];
    console.log("âœ… Payroll records loaded:", window.payrollRecords);
    updateDashboard();
  } catch (err) {
    console.error("âŒ Error loading payroll records:", err);
  }
}

// =============================
// Employee Dropdowns
// =============================
function populateEmployeeDropdowns() {
  const idSel = $("employee_id");
  const nameSel = $("full_name");
  const tpinSel = $("tpin");
  const nrcSel = $("nrc");
  if (!idSel || !nameSel || !tpinSel || !nrcSel) return;

  clearSelect(idSel);
  clearSelect(nameSel);
  clearSelect(tpinSel);
  clearSelect(nrcSel);

  window.employees.forEach(emp => {
    const fullName = `${emp.first_name || ""} ${emp.last_name || ""}`.trim();
    idSel.add(new Option(emp.employee_id, emp.employee_id));
    nameSel.add(new Option(fullName || emp.employee_id, emp.employee_id));
    tpinSel.add(new Option(emp.tpin || "", emp.employee_id));
    nrcSel.add(new Option(emp.nrc || "", emp.employee_id));
  });
}

function syncSelects(empId) {
  ["employee_id","full_name","tpin","nrc"].forEach(id => {
    const el = $(id);
    if (el) el.value = empId;
  });
}

// =============================
// Employee Change & Form Update
// =============================
function onEmployeeChange(e) {
  const empId = e?.target?.value;
  if (!empId) return;
  syncSelects(empId);
  updateEmployeeForm(empId);
}
window.onEmployeeChange = onEmployeeChange;

function updateEmployeeForm(empId) {
  const emp = window.employees.find(x => String(x.employee_id) === String(empId));
  if (!emp) return;
  window.selectedEmployeeId = empId;

  $("department") && ($("department").value = emp.department || "");
  $("basicPay") && ($("basicPay").value = emp.basic ?? "");
  $("housingPay") && ($("housingPay").value = emp.housing ?? "");
  $("transportPay") && ($("transportPay").value = emp.transport ?? "");
  $("bonus") && ($("bonus").value = emp.bonus ?? "");
  $("loan") && ($("loan").value = emp.loan ?? "");

  updateDashboard();
}

// =============================
// Save Employee + Payroll Record
// =============================
async function saveEmployeeFromForm(e) {
  e?.preventDefault();

  const period_id = $("periodSelect")?.value;
  if (!period_id) {
    alert("Please select a payroll period.");
    return;
  }

  const effective_date = $("effective_date")?.value;
  if (!effective_date) {
    alert("Please select an effective date for the payroll.");
    return;
  }

  const newEmp = {
    employee_id: $("employee_id")?.value,
    department: $("department")?.value || "",
    basic: parseFloat($("basicPay")?.value) || 0,
    housing: parseFloat($("housingPay")?.value) || 0,
    transport: parseFloat($("transportPay")?.value) || 0,
    bonus: parseFloat($("bonus")?.value) || 0,
    loan: parseFloat($("loan")?.value) || 0,
    effective_date,
    period_id
  };

  try {
    const res = await fetch("/api/payroll/salaries", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newEmp)
    });

    const text = await res.text();
    if (!res.ok) throw new Error(`Save failed: ${res.status} ${text}`);

    alert("âœ… Employee and salary saved.");
    $("employeeForm")?.reset();
    await loadEmployees();
    await loadPayrollRecords();
  } catch (err) {
    console.error("âŒ Save failed:", err);
    alert("Failed to save employee. See console for details.");
  }
}
window.saveEmployeeFromForm = saveEmployeeFromForm;

// =============================
// Payroll Calculations
// =============================
function calculateDeductions(emp) {
  const gross = (emp.basic || 0) + (emp.housing || 0) + (emp.transport || 0) + (emp.bonus || 0);
  let taxable = gross;
  let paye = 0;

  if (taxable > 9200) { paye += (taxable - 9200) * 0.37; taxable = 9200; }
  if (taxable > 7100) { paye += (taxable - 7100) * 0.30; taxable = 7100; }
  if (taxable > 5100) { paye += (taxable - 5100) * 0.20; taxable = 5100; }

  const napsa = gross * 0.05;
  const nhima = gross * 0.01;
  const net = gross - (paye + napsa + nhima + (emp.loan || 0));

  return { gross, paye, napsa, nhima, net };
}

function calculatePayrollSummary(list) {
  let totalGross = 0, totalNet = 0, totalPAYE = 0, totalNAPSA = 0, totalNHIMA = 0;
  list.forEach(emp => {
    const { gross, paye, napsa, nhima, net } = calculateDeductions(emp);
    totalGross += gross;
    totalPAYE += paye;
    totalNAPSA += napsa;
    totalNHIMA += nhima;
    totalNet += net;
  });
  return {
    totalGross,
    totalNet,
    totalPAYE,
    totalNAPSA,
    totalNHIMA,
    averageSalary: list.length ? totalGross / list.length : 0
  };
}

// =============================
// Employee Table & Payslip
// ==============/
function generatePayslip(index) {
  const emp = employees[index];
  if (!emp) return;
  const doc = new window.jspdf.jsPDF();

// Company Logo (replace with your base64 image)
  const logoImg = "data:image/png;base64,...........// insert your logo base64 here
    doc.addImage(logoImg, "PNG", 150, 10, 40, 20);

  doc.setFontSize(18);
  doc.text("Tax Return Online Solutions", 14, 20);
  doc.setFontSize(10);
  doc.text("4974 Kabelenga Rd, Lusaka Zambia", 14, 26);
  doc.text("Email: finance@tax-centre.com | Tel: +123-456-7890", 14, 32);
  doc.line(14, 36, 195, 36);

  // Employee Info
  doc.setFontSize(9);
  const headerInfo = [
    `Employee: ${emp.first_name} ${emp.last_name}`,
    `Employee ID: ${emp.employee_id}`,
    `TPIN: ${emp.tpin || "N/A"}`,
    `NRC: ${emp.nrc || "N/A"}`,
    `Process Date: ${new Date().toLocaleDateString()}`
  ];
  let x = 14;
  const gap = 38;
  headerInfo.forEach(info => {
    doc.text(info, x, 42);
    x += gap;
  });

 
  // =====================
  // Salary Table
  // =====================
  const { gross, paye, napsa, nhima, net } = calculateDeductions(emp);

  if (doc.autoTable) {
    doc.autoTable({
 startY: 50,
      head: [["Category", "% Rate", "Amount Rate (K)", "Total Amount (K)"]],
      body: [
        ["Basic Pay", "-", emp.basic.toLocaleString(), emp.basic.toLocaleString()],
        ["Housing Allowance", "-", emp.housing.toLocaleString(), emp.housing.toLocaleString()],
        ["Transport Allowance", "-", emp.transport.toLocaleString(), emp.transport.toLocaleString()],
        ["Bonus", emp.bonusRate || "-", emp.bonus.toLocaleString(), emp.bonus.toLocaleString()],
        ["Loan Deduction", emp.loanRate || "-", emp.loan.toLocaleString(), emp.loan.toLocaleString()],
        ["Gross Salary", "-", "-", gross.toLocaleString()],
       ["PAYE", paye.toFixed(2)],
        ["NAPSA", napsa.toFixed(2)],
        ["NHIMA", nhima.toFixed(2)],
        ["Net Pay", net.toLocaleString()]
      ],
      theme: "grid",
      styles: {
        fontSize: 10,
        cellPadding: 4,
      },
      didParseCell: function (data) {
        const col = data.column.index;
        const row = data.row.index;
        // Color earnings green, deductions red
        if (row <= 4 || row === 5 || row === 9) {
          data.cell.styles.fillColor = [200, 255, 200]; // light green for earnings
        } else {
          data.cell.styles.fillColor = [255, 200, 200]; // light red for deductions
        }
      }
    });
  }

    // Summary Table - accumulative payments to 12 months
    // =====================
    const startY = doc.lastAutoTable.finalY + 10;
    const remainingMonths = 12 - (new Date().getMonth() + 1); // months remaining including current
    const totalRemainingGross = gross * remainingMonths;
    const totalRemainingLoan = (emp.loan || 0) * remainingMonths;
    const totalRemainingNet = net * remainingMonths;

    doc.text("Accumulative Payments for Remaining Months", 14, startY);
    doc.autoTable({
      startY: startY + 4,
      head: [["Description", "Amount per Month (K)", "Remaining Months", "Total Amount (K)"]],
      body: [
        ["Gross Salary", gross.toLocaleString(), remainingMonths, totalRemainingGross.toLocaleString()],
        ["Loan Deduction", (emp.loan || 0).toLocaleString(), remainingMonths, totalRemainingLoan.toLocaleString()],
        ["Net Pay", net.toLocaleString(), remainingMonths, totalRemainingNet.toLocaleString()]
      ],
      theme: "grid",
      styles: { fontSize: 10, cellPadding: 4 }
    });
  

  doc.save(`${emp.employee_id}_Payslip.pdf`);
}

// =============================
// Charts (with Export)
// =============================
function renderCharts(summary) {
  const dCanvas = $("deductionChart");
  const sCanvas = $("salaryChart");
  if (!dCanvas || !sCanvas) return;

  if (window.deductionChart) window.deductionChart.destroy();
  if (window.salaryChart) window.salaryChart.destroy();

  window.deductionChart = new Chart(dCanvas, {
    type: "doughnut",
    data: {
      labels: ["PAYE", "NAPSA", "NHIMA"],
      datasets: [{
        data: [summary.totalPAYE, summary.totalNAPSA, summary.totalNHIMA],
        backgroundColor: ["#ef4444", "#f59e0b", "#3b82f6"]
      }]
    }
  });

  const emp = employees.find(e => e.employee_id === selectedEmployeeId);
  const label = emp ? `${emp.first_name} ${emp.last_name}` : "Employee";

  window.salaryChart = new Chart(sCanvas, {
    type: "bar",
    data: {
      labels: selectedEmployeeId ? [label] : [],
      datasets: [{
        label: "Gross Salary",
        data: selectedEmployeeId ? [summary.totalGross] : [],
        backgroundColor: "#10b981"
      }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
}

// Export Charts Button
function exportCharts() {
  if (window.deductionChart) {
    const a = document.createElement("a");
    a.href = window.deductionChart.toBase64Image();
    a.download = "deductions_chart.png";
    a.click();
  }
  if (window.salaryChart) {
    const a = document.createElement("a");
    a.href = window.salaryChart.toBase64Image();
    a.download = "salary_chart.png";
    a.click();
  }
}
window.exportCharts = exportCharts;

 
// =============================
// Employee Table & Payslip
// =============================
function renderEmployeeTable() {
  const tbody = document.querySelector("#employeeTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  const list = selectedEmployeeId
    ? employees.filter(e => e.employee_id === selectedEmployeeId)
    : employees;

  list.forEach(emp => {
    const { gross, net } = calculateDeductions(emp);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-4 py-2">${emp.first_name} ${emp.last_name}</td>
      <td class="px-4 py-2">K ${gross.toLocaleString()}</td>
      <td class="px-4 py-2">K ${net.toLocaleString()}</td>
      <td class="px-4 py-2">
        <button 
          type="button" 
          data-id="${emp.employee_id}" 
          class="payslip-btn bg-blue-600 text-white px-3 py-1 rounded">
          View Payslip
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Attach events to generate PDF Payslip
  document.querySelectorAll(".payslip-btn").forEach(btn => {
    btn.addEventListener("click", (ev) => {
      const empId = ev.currentTarget.dataset.id;
      const idx = employees.findIndex(e => e.employee_id === empId);
      if (idx !== -1) {
        generatePayslip(idx); // âœ… use your existing PDF generator
      } else {
        alert("Employee not found for payslip generation.");
      }
    });
  });
}


// =============================
// Dashboard Update
// =============================
function updateDashboard() {
  const list = window.selectedEmployeeId
    ? (window.payrollRecords || []).filter(r => r.employee_id === window.selectedEmployeeId)
    : (window.payrollRecords || []);

  const summary = calculatePayrollSummary(list);

  $("totalPayroll").textContent = `K ${summary.totalGross.toLocaleString()}`;
  $("averageSalary").textContent = `K ${summary.averageSalary.toLocaleString()}`;
  $("payeContributions").textContent = `K ${summary.totalPAYE.toLocaleString()}`;
  $("netPayDistributed").textContent = `K ${summary.totalNet.toLocaleString()}`;

  renderCharts(summary);
  renderEmployeeTable?.();
}
window.updateDashboard = updateDashboard;

// =============================
// Department Settings
// =============================
function renderDepartmentSettings() {
  const tbody = document.querySelector("#deptSettings tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  Object.keys(departmentConfigs).forEach(dept => {
    const cfg = departmentConfigs[dept];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-4 py-2">${dept}</td>
      <td class="px-4 py-2"><input data-dept="${dept}" data-field="basic" class="dept-input px-2 py-1 border rounded" value="${cfg.basic}"></td>
      <td class="px-4 py-2"><input data-dept="${dept}" data-field="housing" class="dept-input px-2 py-1 border rounded" value="${cfg.housing}"></td>
      <td class="px-4 py-2"><input data-dept="${dept}" data-field="transport" class="dept-input px-2 py-1 border rounded" value="${cfg.transport}"></td>
      <td class="px-4 py-2"><input data-dept="${dept}" data-field="bonus" class="dept-input px-2 py-1 border rounded" value="${cfg.bonus}"></td>
      <td class="px-4 py-2"><button data-dept="${dept}" class="save-dept-btn bg-green-600 text-white px-3 py-1 rounded">Save</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".save-dept-btn").forEach(btn => {
    btn.addEventListener("click", (ev) => {
      const dept = ev.currentTarget.dataset.dept;
      const inputs = document.querySelectorAll(`.dept-input[data-dept="${dept}"]`);
      inputs.forEach(inp => {
        departmentConfigs[dept][inp.dataset.field] = parseFloat(inp.value) || 0;
      });
      alert(`Saved settings for ${dept}`);
    });
  });
}

// =============================
// Init on DOM Ready
// =============================
document.addEventListener("DOMContentLoaded", async () => {
  await populatePeriodDropdown();
  await loadEmployees();
  await loadPayrollRecords();

  ["employee_id", "full_name", "tpin", "nrc"].forEach(id => {
    $(id)?.addEventListener("change", onEmployeeChange);
  });
  $("employeeForm")?.addEventListener("submit", saveEmployeeFromForm);
  $("exportChartsBtn")?.addEventListener("click", exportCharts);

  renderDepartmentSettings?.();
  updateDashboard?.();

  console.log("ðŸš€ Payroll page initialized");
});
</script>

 
</body>
</html>




















































