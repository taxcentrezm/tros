<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINANCE Management - EnterpriseERP</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            blue: '#3b82f6',
                            indigo: '#6366f1',
                            cyan: '#06b6d4',
                            emerald: '#10b981',
                            amber: '#f59e0b',
                            rose: '#f43f5e'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body class="bg-gray-50 font-sans antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 relative z-10">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-600 to-primary-800 rounded-lg flex items-center justify-center">
                        <i data-feather="grid" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-semibold text-primary-900">SMAIT ERP</span>
                </div>
                
                <div class="hidden lg:flex space-x-1">
                    <a href="index.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Dashboard</a>
                    <a href="hr.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">HR</a>
                    <a href="inventory.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Inventory</a>
                    <a href="finance.html" class="px-4 py-2 text-primary-700 bg-primary-100 rounded-lg transition-colors font-medium">Finance</a>
                    <a href="sales.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Sales & CRM</a>
                    <a href="reports.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Reports</a>
                    <a href="payroll.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Payroll</a>
                    <a href="salaries.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Salaries</a>
                     <a href="loans.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Loans</a>
                     <a href="employee.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Employees</a>
                    <a href="fiscal.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Fiscal</a>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                            <i data-feather="bell" class="w-5 h-5 text-primary-600"></i>
                        </button>
                        <span class="absolute -top-1 -right-1 bg-accent-rose text-white text-xs rounded-full w-5 h-5 flex items-center justify-center border-2 border-white">3</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-primary-700 rounded-full flex items-center justify-center shadow-sm">
                            <i data-feather="user" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="hidden md:block">
                            <p class="text-sm font-medium text-primary-900">Admin User</p>
                            <p class="text-xs text-primary-500">System Administrator</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

 <!-- ======= REPLACE MAIN CONTENT WITH THIS ENHANCED FINANCE LAYOUT ======= -->
<div class="max-w-7xl mx-auto p-6">

  <!-- Page header + Period filter -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold">Finance Dashboard</h1>
      <p class="text-sm text-gray-600">Overview, drill-downs and extended trial balance.</p>
    </div>

    <!-- Period filter -->
    <form id="periodForm" class="flex gap-2 items-center">
      <label class="text-sm text-gray-600">Period:</label>
      <input id="startDate" type="date" class="px-3 py-2 border rounded" />
      <span class="text-sm text-gray-500">to</span>
      <input id="endDate" type="date" class="px-3 py-2 border rounded" />
      <button type="submit" class="ml-2 px-4 py-2 bg-primary-600 text-white rounded">Apply</button>
      <button id="clearPeriod" type="button" class="ml-2 px-3 py-2 bg-gray-100 rounded text-sm">Clear</button>
    </form>
  </div>

  <!-- Summary Cards (rearranged, professional) -->
  <section class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Revenue</p>
      <h3 id="totalRevenue" class="text-2xl font-bold text-green-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Expenses</p>
      <h3 id="totalExpenses" class="text-2xl font-bold text-red-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Net Profit</p>
      <h3 id="netProfit" class="text-2xl font-bold text-blue-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Cash Flow (Operating)</p>
      <h3 id="cashFlowOperating" class="text-2xl font-bold text-emerald-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Equity</p>
      <h3 id="equityTotal" class="text-2xl font-bold text-purple-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Working Capital</p>
      <h3 id="workingCapital" class="text-2xl font-bold text-yellow-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Capital Expenses (CapEx)</p>
      <h3 id="totalCapex" class="text-2xl font-bold text-orange-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Capital Revenue (CapRev)</p>
      <h3 id="totalCaprev" class="text-2xl font-bold text-indigo-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Liabilities</p>
      <h3 id="totalLiabilities" class="text-2xl font-bold text-pink-600">ZMW 0.00</h3>
    </div>
  </section>

  <!-- Charts: two rows -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Monthly Revenue vs Expenses</h2>
      <canvas id="lineChart" height="220"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Expense Breakdown</h2>
      <canvas id="pieChart" height="220"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Net Profit Trend</h2>
      <canvas id="netProfitTrend" height="220"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Liabilities vs Assets</h2>
      <canvas id="liabilitiesAssetsChart" height="220"></canvas>
    </div>
  </section>

  <!-- Transactions Table with richer details + export buttons -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Transactions</h2>
      <div class="flex gap-2">
        <input id="transactionSearch" type="text" placeholder="Search..." class="px-3 py-2 border rounded" />
        <button id="importBtn" class="px-3 py-2 bg-purple-600 text-white rounded">Import</button>
        <button id="exportCSV" class="px-3 py-2 bg-blue-600 text-white rounded">Export CSV</button>
        <button id="exportExcel" class="px-3 py-2 bg-green-600 text-white rounded">Export Excel</button>
        <button id="exportPDF" class="px-3 py-2 bg-red-600 text-white rounded">Export PDF</button>
      </div>
    </div>

    <div class="overflow-auto">
      <table id="transactionTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Date</th>
            <th class="px-3 py-2 text-left">Reference</th>
            <th class="px-3 py-2 text-left">Description</th>
            <th class="px-3 py-2 text-left">Category</th>
            <th class="px-3 py-2 text-right">Amount</th>
            <th class="px-3 py-2 text-left">Payment Method</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-left">Type</th>
          </tr>
        </thead>
        <tbody id="transactionBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Balance & Extended Trial Balance -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Trial Balance</h2>
        <div class="flex gap-2">
          <button id="exportTrialBalance" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export TB</button>
          <button id="validateLedger" class="px-3 py-2 bg-yellow-500 text-white rounded text-sm">Validate Ledger</button>
        </div>
      </div>
      <div class="overflow-auto">
        <table id="trialBalanceTable" class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">Account</th>
              <th class="px-3 py-2 text-right">Debit</th>
              <th class="px-3 py-2 text-right">Credit</th>
              <th class="px-3 py-2 text-right">Balance</th>
            </tr>
          </thead>
          <tbody id="trialBalanceBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <p id="ledgerCheck" class="mt-3 text-sm"></p>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Extended Trial Balance (ETB)</h2>
        <button id="exportETB" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export ETB</button>
      </div>

      <div class="overflow-auto">
        <table id="extendedTB" class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 text-left">Account</th>
              <th class="px-2 py-2 text-right">Debit</th>
              <th class="px-2 py-2 text-right">Credit</th>
              <th class="px-2 py-2 text-right">Adj.</th>
              <th class="px-2 py-2 text-right">Adj. Debit</th>
              <th class="px-2 py-2 text-right">Adj. Credit</th>
              <th class="px-2 py-2 text-right">P&L</th>
              <th class="px-2 py-2 text-right">Balance Sheet</th>
            </tr>
          </thead>
          <tbody id="extendedTBBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Balance Sheet -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Balance Sheet</h2>
      <div class="flex gap-2">
        <button id="exportBalanceSheet" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export Balance Sheet</button>
      </div>
    </div>

    <div class="overflow-auto">
      <table id="balanceSheetTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Fiscal Year</th>
            <th class="px-3 py-2 text-right">Assets</th>
            <th class="px-3 py-2 text-right">Liabilities</th>
            <th class="px-3 py-2 text-right">Equity</th>
          </tr>
        </thead>
        <tbody id="balanceSheetBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Asset Lifecycle -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Asset Lifecycle</h2>
    <div class="overflow-auto">
      <table id="assetLifecycleTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Asset</th>
            <th class="px-3 py-2 text-right">Purchase</th>
            <th class="px-3 py-2 text-right">Sale</th>
            <th class="px-3 py-2 text-right">Gain/Loss</th>
            <th class="px-3 py-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody id="assetLifecycleBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Journal: entries expandable to show lines inline -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Journal Entries</h2>
    <div class="overflow-auto">
      <table id="journalEntriesTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2">Entry ID</th>
            <th class="px-3 py-2">Date</th>
            <th class="px-3 py-2">Description</th>
            <th class="px-3 py-2">Lines</th>
          </tr>
        </thead>
        <tbody id="journalEntriesBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Export/Import Journal + Journal Lines -->
  <section class="flex gap-4 mb-12">
    <button id="exportJournalBtn" class="px-4 py-2 bg-green-600 text-white rounded">Export Journal CSV</button>
    <label class="px-4 py-2 bg-yellow-500 text-white rounded cursor-pointer">
      Import Journal CSV
      <input id="importJournalInput" type="file" accept=".csv" class="hidden" />
    </label>
  </section>

  <!-- Drill-down modal (hidden) -->
  <div id="drillDownModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-3xl">
      <div class="flex justify-between items-center mb-3">
        <h3 id="drillDownTitle" class="text-lg font-semibold">Drill-down</h3>
        <button id="closeDrillDown" class="px-3 py-1 bg-gray-200 rounded">Close</button>
      </div>

      <div class="overflow-auto max-h-80">
        <table class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1">Date</th>
              <th class="px-2 py-1">Reference</th>
              <th class="px-2 py-1">Description</th>
              <th class="px-2 py-1 text-right">Debit</th>
              <th class="px-2 py-1 text-right">Credit</th>
            </tr>
          </thead>
          <tbody id="drillDownBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>
<!-- ======= END REPLACEMENT CONTENT ======= -->

    
<!-- Modal -->
<div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold text-primary-800 mb-4">Add Transaction</h2>
    <form id="transactionForm" class="space-y-4">
      <input id="txnDate" name="date" type="date" required class="w-full px-4 py-2 border rounded-lg" />
      <input id="txnDesc" name="description" type="text" placeholder="Description" required class="w-full px-4 py-2 border rounded-lg" />
      <input id="txnAmount" name="amount" type="number" placeholder="Amount" required class="w-full px-4 py-2 border rounded-lg" />

      <select id="txnType" name="type" required class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Type</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
        <option value="capital_expense">Capital Expense</option>
        <option value="capital_revenue">Capital Revenue</option>
        <option value="liability">Liability</option>
        <option value="asset_sale">Asset Sale</option>
      </select>

      <!-- Transaction Modal -->
<select id="category" name="category" required class="w-full px-4 py-2 border rounded-lg">
  <option value="">Select Category</option>
  <!-- Options will be populated dynamically -->
</select>


      <div class="flex justify-end space-x-2">
        <button type="button" id="cancelModal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700">Add</button>
      </div>
    </form>
  </div>
</div>

 <div id="exportFeedback" class="fixed bottom-6 right-6 bg-primary-600 text-white px-4 py-2 rounded-lg shadow-lg hidden transition-opacity duration-500"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // =========================
  // Feather icons & AOS
  // =========================
  feather.replace();
  AOS.init();

  // =========================
  // DOM References
  // =========================
  const transactionModal = document.getElementById("transactionModal");
  const openModalBtn = document.getElementById("openModal");
  const cancelModalBtn = document.getElementById("cancelModal");
  const transactionForm = document.getElementById("transactionForm");
  const txnTypeSelect = document.getElementById("txnType");
  const categorySelect = document.getElementById("category");

  const transactionBody = document.getElementById("transactionBody");
  const trialBalanceBody = document.getElementById("trialBalanceBody");
  const balanceSheetBody = document.getElementById("balanceSheetBody");
  const assetLifecycleBody = document.getElementById("assetLifecycleBody");

  const revenueEl = document.getElementById("totalRevenue");
  const expensesEl = document.getElementById("totalExpenses");
  const profitEl = document.getElementById("netProfit");
  const capexEl = document.getElementById("totalCapex");
  const caprevEl = document.getElementById("totalCaprev");
  const liabilitiesEl = document.getElementById("totalLiabilities");

  let transactions = [];
  let chartOfAccounts = [];

  // =========================
  // Load Chart of Accounts
  // =========================
  async function loadChartOfAccounts() {
    try {
      const res = await fetch("/api/finance/chart_of_accounts");
      const result = await res.json();
      if (!res.ok) throw new Error(result.error || "Failed to fetch chart of accounts");
      chartOfAccounts = result.data || [];
    } catch (err) {
      console.error("Error loading chart of accounts:", err);
    }
  }

  // =========================
  // Modal Controls
  // =========================
  openModalBtn.addEventListener("click", async () => {
    transactionModal.classList.remove("hidden");
    transactionForm.reset();
    if (!chartOfAccounts.length) await loadChartOfAccounts();
  });

  cancelModalBtn.addEventListener("click", () => {
    transactionModal.classList.add("hidden");
    transactionForm.reset();
  });

  transactionModal.addEventListener("click", (e) => {
    if (e.target === transactionModal) transactionModal.classList.add("hidden");
  });

  // =========================
  // Filter Categories
  // =========================
  function filterCategories() {
    const type = txnTypeSelect.value;
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    if (!type || !chartOfAccounts.length) return;

    let accountType;
    switch (type) {
      case "income":
      case "capital_revenue": accountType = "revenue"; break;
      case "expense":
      case "capital_expense": accountType = "expense"; break;
      case "liability": accountType = "liability"; break;
      case "asset_sale": accountType = "asset"; break;
    }

    chartOfAccounts
      .filter(acc => acc.type === accountType)
      .forEach(acc => {
        const option = document.createElement("option");
        option.value = acc.account_id;
        option.textContent = `${acc.code} - ${acc.name}`;
        categorySelect.appendChild(option);
      });
  }
  txnTypeSelect.addEventListener("change", filterCategories);

  // =========================
  // Add Transaction
  // =========================
  transactionForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const date = transactionForm.querySelector('input[name="date"]').value;
    const description = transactionForm.querySelector('input[name="description"]').value;
    const amount = parseFloat(transactionForm.querySelector('input[name="amount"]').value);
    const type = txnTypeSelect.value;
    const account_id = parseInt(categorySelect.value);

    if (!date || !description || !amount || !type || !Number.isFinite(account_id)) {
      return alert("Please fill in all required fields!");
    }

    const formData = { date, description, amount, type, account_id };

    try {
      const res = await fetch("/api/finance/transactions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      });
      const result = await res.json();
      if (!res.ok) throw new Error(result.error || "Failed to add transaction");

      alert(result.message || "Transaction added!");
      transactionModal.classList.add("hidden");
      loadTransactions();
    } catch (err) {
      console.error("Error adding transaction:", err);
    }
  });

  // =========================
  // Charts
  // =========================
  let lineChartInstance, pieChartInstance;

  function initCharts() {
    const lineCtx = document.getElementById("lineChart").getContext("2d");
    const pieCtx = document.getElementById("pieChart").getContext("2d");

    lineChartInstance = new Chart(lineCtx, {
      type: "line",
      data: { labels: [], datasets: [
        { label: "Revenue", data: [], borderColor: "#10b981", backgroundColor: "rgba(16,185,129,0.2)", fill: true, tension: 0.4 },
        { label: "Expenses", data: [], borderColor: "#ef4444", backgroundColor: "rgba(239,68,68,0.2)", fill: true, tension: 0.4 }
      ]},
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });

    pieChartInstance = new Chart(pieCtx, {
      type: "pie",
      data: { labels: [], datasets: [{ data: [], backgroundColor: ["#fbbf24","#f87171","#60a5fa","#34d399","#c084fc"] }]},
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });
  }

  function updateCharts(data) {
    if (!lineChartInstance || !pieChartInstance) return;

    const monthly = {};
    data.forEach(tx => {
      const month = tx.date.slice(0, 7);
      if (!monthly[month]) monthly[month] = { income: 0, expense: 0 };
      if (["income","capital_revenue"].includes(tx.type)) monthly[month].income += tx.amount;
      if (["expense","capital_expense"].includes(tx.type)) monthly[month].expense += tx.amount;
    });

    const months = Object.keys(monthly).sort();
    lineChartInstance.data.labels = months;
    lineChartInstance.data.datasets[0].data = months.map(m => monthly[m].income);
    lineChartInstance.data.datasets[1].data = months.map(m => monthly[m].expense);
    lineChartInstance.update();

    const categoryMap = {};
    data.filter(tx => ["expense","capital_expense"].includes(tx.type)).forEach(tx => {
      categoryMap[tx.category_name || tx.category] = (categoryMap[tx.category_name || tx.category] || 0) + tx.amount;
    });

    pieChartInstance.data.labels = Object.keys(categoryMap);
    pieChartInstance.data.datasets[0].data = Object.values(categoryMap);
    pieChartInstance.update();
  }

  // =========================
  // Summary Cards
  // =========================
  function updateSummary(data) {
    const income = data.filter(tx => ["income","capital_revenue"].includes(tx.type)).reduce((s, tx) => s + tx.amount, 0);
    const expenses = data.filter(tx => ["expense","capital_expense"].includes(tx.type)).reduce((s, tx) => s + tx.amount, 0);
    const capex = data.filter(tx => tx.type === "capital_expense").reduce((s, tx) => s + tx.amount, 0);
    const caprev = data.filter(tx => tx.type === "capital_revenue").reduce((s, tx) => s + tx.amount, 0);
    const liabilities = data.filter(tx => tx.type === "liability").reduce((s, tx) => s + tx.amount, 0);

    revenueEl.textContent = `ZMW ${income.toFixed(2)}`;
    expensesEl.textContent = `ZMW ${expenses.toFixed(2)}`;
    profitEl.textContent = `ZMW ${(income - expenses).toFixed(2)}`;
    capexEl.textContent = `ZMW ${capex.toFixed(2)}`;
    caprevEl.textContent = `ZMW ${caprev.toFixed(2)}`;
    liabilitiesEl.textContent = `ZMW ${liabilities.toFixed(2)}`;
  }

  // =========================
  // Data Loaders
  // =========================
  async function loadTransactions() {
    try {
      const res = await fetch("/api/finance/transactions");
      const result = await res.json();
      if (!res.ok) throw new Error(result.error || "Failed to load transactions");
      transactions = result.data || [];
      renderTransactions(transactions);
      updateCharts(transactions);
      updateSummary(transactions);
    } catch (err) {
      console.error("Error loading transactions:", err);
    }
  }

  function renderTransactions(data) {
    transactionBody.innerHTML = "";
    data.forEach(tx => {
      transactionBody.innerHTML += `
        <tr>
          <td class="px-4 py-2">${tx.date}</td>
          <td class="px-4 py-2">${tx.description}</td>
          <td class="px-4 py-2">${tx.category_name || tx.category}</td>
          <td class="px-4 py-2">ZMW ${tx.amount.toFixed(2)}</td>
          <td class="px-4 py-2">${tx.type}</td>
        </tr>`;
    });
  }

  async function loadTrialBalance() {
    const res = await fetch("/api/finance/trial-balance");
    const { data } = await res.json();
    trialBalanceBody.innerHTML = "";
    data.forEach(entry => {
      trialBalanceBody.innerHTML += `
        <tr>
          <td class="px-4 py-2">${entry.account}</td>
          <td class="px-4 py-2">ZMW ${entry.debit.toFixed(2)}</td>
          <td class="px-4 py-2">ZMW ${entry.credit.toFixed(2)}</td>
          <td class="px-4 py-2">${entry.fiscal_year}</td>
        </tr>`;
    });
  }

  async function loadBalanceSheet() {
    const res = await fetch("/api/finance/balance-sheet");
    const { data } = await res.json();
    balanceSheetBody.innerHTML = "";
    data.forEach(entry => {
      balanceSheetBody.innerHTML += `
        <tr>
          <td class="px-4 py-2">${entry.fiscal_year}</td>
          <td class="px-4 py-2">ZMW ${entry.assets.toFixed(2)}</td>
          <td class="px-4 py-2">ZMW ${entry.liabilities.toFixed(2)}</td>
          <td class="px-4 py-2">ZMW ${entry.equity.toFixed(2)}</td>
        </tr>`;
    });
  }

  async function loadAssets() {
    const res = await fetch("/api/finance/assets");
    const { data } = await res.json();
    assetLifecycleBody.innerHTML = "";
    data.forEach(asset => {
      assetLifecycleBody.innerHTML += `
        <tr>
          <td class="px-4 py-2">${asset.category}</td>
          <td class="px-4 py-2">ZMW ${asset.purchase.toFixed(2)}</td>
          <td class="px-4 py-2">ZMW ${asset.sale.toFixed(2)}</td>
          <td class="px-4 py-2">ZMW ${asset.gain_loss.toFixed(2)}</td>
          <td class="px-4 py-2">${asset.status}</td>
        </tr>`;
    });
  }

  // =========================
  // Import & Export
  // =========================
  document.getElementById("importBtn").addEventListener("click", () => {
    document.getElementById("importFile").click();
  });

  document.getElementById("importFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    const ext = file.name.split(".").pop().toLowerCase();

    if (ext === "csv") {
      reader.onload = evt => {
        const lines = evt.target.result.split("\n").map(l => l.split(","));
        lines.slice(1).forEach(row => {
          if (row.length >= 5) {
            const [date, desc, category, amount, type] = row;
            if (date && amount && type) {
              transactions.push({ date, description: desc, category, amount: parseFloat(amount), type });
            }
          }
        });
        renderTransactions(transactions);
        updateSummary(transactions);
        updateCharts(transactions);
      };
      reader.readAsText(file);
    } else if (ext === "xlsx") {
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
        sheet.slice(1).forEach(row => {
          if (row.length >= 5) {
            const [date, desc, category, amount, type] = row;
            transactions.push({ date, description: desc, category, amount: parseFloat(amount), type });
          }
        });
        renderTransactions(transactions);
        updateSummary(transactions);
        updateCharts(transactions);
      };
      reader.readAsArrayBuffer(file);
    }
  });

  document.getElementById("exportCSV").addEventListener("click", () => {
    const rows = [["Date","Description","Category","Amount","Type"], ...transactions.map(tx => [tx.date, tx.description, tx.category, tx.amount, tx.type])];
    const csvContent = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "transactions.csv";
    link.click();
  });

  document.getElementById("exportExcel").addEventListener("click", () => {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(transactions);
    XLSX.utils.book_append_sheet(wb, ws, "Transactions");
    XLSX.writeFile(wb, "transactions.xlsx");
  });

  document.getElementById("exportPDF").addEventListener("click", () => {
    const doc = new jspdf.jsPDF();
    doc.autoTable({ html: "#transactionTable" });
    doc.save("transactions.pdf");
  });

  // =========================
  // Init
  // =========================
  initCharts();
  loadTransactions();
  loadTrialBalance();
  loadBalanceSheet();
  loadAssets();
});
</script>
    <script>
         
  const container = document.getElementById("journalTables");
 

  

async function loadJournalEntries() {
  const res = await fetch("/api/finance/journal-entries");
  const { data } = await res.json();
  const tbody = document.querySelector("#journalEntriesTable tbody");
  tbody.innerHTML = "";

  data.forEach(entry => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="px-4 py-2 border">${entry.entry_id}</td>
      <td class="px-4 py-2 border">${entry.date}</td>
      <td class="px-4 py-2 border">${entry.description}</td>
    `;
    tbody.appendChild(row);
  });
}

async function loadJournalLines() {
  const res = await fetch("/api/finance/journal-lines");
  const { data } = await res.json();
  const tbody = document.querySelector("#journalLinesTable tbody");
  tbody.innerHTML = "";

  data.forEach(line => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="px-4 py-2 border">${line.line_id}</td>
      <td class="px-4 py-2 border">${line.entry_id}</td>
      <td class="px-4 py-2 border">${line.account}</td>
      <td class="px-4 py-2 border">${line.debit}</td>
      <td class="px-4 py-2 border">${line.credit}</td>
    `;
    tbody.appendChild(row);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  loadJournalEntries();
  loadJournalLines();
});

let previewRows = [];
let previewType = "";

document.getElementById("importJournalInput").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const text = await file.text();
  const rows = text.split("\n").map(r => r.split(","));
  previewType = rows[0].includes("entry_id") ? "lines" : "entries";

  previewRows = rows.map((r, i) => `<tr>${r.map(cell => `<td class="border px-2 py-1">${cell}</td>`).join("")}</tr>`).join("");
  document.getElementById("importPreviewContent").innerHTML = `<table class="table-auto w-full border"><tbody>${previewRows}</tbody></table>`;
  document.getElementById("importPreviewModal").classList.remove("hidden");
});

document.getElementById("cancelImportBtn").addEventListener("click", () => {
  document.getElementById("importPreviewModal").classList.add("hidden");
});

document.getElementById("confirmImportBtn").addEventListener("click", async () => {
  const csvText = previewRows.map(row => row.replace(/<\/?[^>]+(>|$)/g, "")).join("\n");

  const res = await fetch("/api/finance/import-journal", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ csvText, type: previewType }),
  });

  const result = await res.json();
  alert(result.success ? result.message : "Import failed: " + JSON.stringify(result.errors));
  document.getElementById("importPreviewModal").classList.add("hidden");
  loadJournalEntries();
  loadJournalLines();
});


function exportTableToCSV(tableId, filename) {
  const rows = document.querySelectorAll(`#${tableId} tr`);
  const csv = Array.from(rows).map(row =>
    Array.from(row.cells).map(cell => `"${cell.innerText}"`).join(",")
  ).join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

document.getElementById("exportJournalBtn").addEventListener("click", () => {
  exportTableToCSV("journalEntriesTable", "journal_entries.csv");
  exportTableToCSV("journalLinesTable", "journal_lines.csv");
});
document.getElementById("importJournalInput").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const text = await file.text();
  const rows = text.split("\n").map(r => r.split(","));

  console.log("Imported CSV rows:", rows);

  // You can now POST these rows to /api/finance/journal-entries or journal-lines
  // Or preview them in a modal before saving
});

    </script>




</body>
</html>




































































