<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINANCE Management - EnterpriseERP</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            blue: '#3b82f6',
                            indigo: '#6366f1',
                            cyan: '#06b6d4',
                            emerald: '#10b981',
                            amber: '#f59e0b',
                            rose: '#f43f5e'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body class="bg-gray-50 font-sans antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 relative z-10">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-600 to-primary-800 rounded-lg flex items-center justify-center">
                        <i data-feather="grid" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-semibold text-primary-900">SMAIT ERP</span>
                </div>
                
                <div class="hidden lg:flex space-x-1">
                    <a href="index.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Dashboard</a>
                    <a href="hr.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">HR</a>
                    <a href="inventory.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Inventory</a>
                    <a href="finance.html" class="px-4 py-2 text-primary-700 bg-primary-100 rounded-lg transition-colors font-medium">Finance</a>
                    <a href="sales.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Sales & CRM</a>
                    <a href="reports.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Reports</a>
                    <a href="payroll.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Payroll</a>
                    <a href="salaries.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Salaries</a>
                     <a href="loans.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Loans</a>
                     <a href="employee.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Employees</a>
                    <a href="fiscal.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Fiscal</a>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                            <i data-feather="bell" class="w-5 h-5 text-primary-600"></i>
                        </button>
                        <span class="absolute -top-1 -right-1 bg-accent-rose text-white text-xs rounded-full w-5 h-5 flex items-center justify-center border-2 border-white">3</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-primary-700 rounded-full flex items-center justify-center shadow-sm">
                            <i data-feather="user" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="hidden md:block">
                            <p class="text-sm font-medium text-primary-900">Admin User</p>
                            <p class="text-xs text-primary-500">System Administrator</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

 <!-- ======= REPLACE MAIN CONTENT WITH THIS ENHANCED FINANCE LAYOUT ======= -->
<div class="max-w-7xl mx-auto p-6">

  <!-- Page header + Period filter -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold">Finance Dashboard</h1>
      <p class="text-sm text-gray-600">Overview, drill-downs and extended trial balance.</p>
    </div>

    <!-- Period filter -->
    <form id="periodForm" class="flex gap-2 items-center">
      <label class="text-sm text-gray-600">Period:</label>
      <input id="startDate" type="date" class="px-3 py-2 border rounded" />
      <span class="text-sm text-gray-500">to</span>
      <input id="endDate" type="date" class="px-3 py-2 border rounded" />
      <button type="submit" class="ml-2 px-4 py-2 bg-primary-600 text-white rounded">Apply</button>
      <button id="clearPeriod" type="button" class="ml-2 px-3 py-2 bg-gray-100 rounded text-sm">Clear</button>
    </form>
  </div>

  <!-- Summary Cards (rearranged, professional) -->
  <section class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Revenue</p>
      <h3 id="totalRevenue" class="text-2xl font-bold text-green-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Expenses</p>
      <h3 id="totalExpenses" class="text-2xl font-bold text-red-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Net Profit</p>
      <h3 id="netProfit" class="text-2xl font-bold text-blue-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Cash Flow (Operating)</p>
      <h3 id="cashFlowOperating" class="text-2xl font-bold text-emerald-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Equity</p>
      <h3 id="equityTotal" class="text-2xl font-bold text-purple-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Working Capital</p>
      <h3 id="workingCapital" class="text-2xl font-bold text-yellow-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Capital Expenses (CapEx)</p>
      <h3 id="totalCapex" class="text-2xl font-bold text-orange-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Capital Revenue (CapRev)</p>
      <h3 id="totalCaprev" class="text-2xl font-bold text-indigo-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Liabilities</p>
      <h3 id="totalLiabilities" class="text-2xl font-bold text-pink-600">ZMW 0.00</h3>
    </div>
  </section>

  <!-- Charts: two rows -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Monthly Revenue vs Expenses</h2>
      <canvas id="lineChart" height="220"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Expense Breakdown</h2>
      <canvas id="pieChart" height="220"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Net Profit Trend</h2>
      <canvas id="netProfitTrend" height="220"></canvas>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="font-semibold mb-3">Liabilities vs Assets</h2>
      <canvas id="liabilitiesAssetsChart" height="220"></canvas>
    </div>
  </section>

  <!-- Transactions Table with richer details + export buttons -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Transactions</h2>
  
      <div class="flex gap-2">
        <input id="transactionSearch" type="text" placeholder="Search..." class="px-3 py-2 border rounded" />
          <button 
    class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 transition"
    onclick="openTransactionModal()">
    + Add Transaction
  </button>
        <button id="importBtn" class="px-3 py-2 bg-purple-600 text-white rounded">Import</button>
        <button id="exportCSV" class="px-3 py-2 bg-blue-600 text-white rounded">Export CSV</button>
        <button id="exportExcel" class="px-3 py-2 bg-green-600 text-white rounded">Export Excel</button>
        <button id="exportPDF" class="px-3 py-2 bg-red-600 text-white rounded">Export PDF</button>
      </div>
    </div>

    <div class="overflow-auto">
      <table id="transactionTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Date</th>
            <th class="px-3 py-2 text-left">Reference</th>
            <th class="px-3 py-2 text-left">Description</th>
            <th class="px-3 py-2 text-left">Category</th>
            <th class="px-3 py-2 text-right">Amount</th>
            <th class="px-3 py-2 text-left">Payment Method</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-left">Type</th>
          </tr>
        </thead>
        <tbody id="transactionBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Balance & Extended Trial Balance -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Trial Balance</h2>
        <div class="flex gap-2">
          <button id="exportTrialBalance" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export TB</button>
          <button id="validateLedger" class="px-3 py-2 bg-yellow-500 text-white rounded text-sm">Validate Ledger</button>
        </div>
      </div>
      <div class="overflow-auto">
        <table id="trialBalanceTable" class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">Account</th>
              <th class="px-3 py-2 text-right">Debit</th>
              <th class="px-3 py-2 text-right">Credit</th>
              <th class="px-3 py-2 text-right">Balance</th>
            </tr>
          </thead>
          <tbody id="trialBalanceBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <p id="ledgerCheck" class="mt-3 text-sm"></p>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Extended Trial Balance (ETB)</h2>
        <button id="exportETB" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export ETB</button>
      </div>

      <div class="overflow-auto">
        <table id="extendedTB" class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 text-left">Account</th>
              <th class="px-2 py-2 text-right">Debit</th>
              <th class="px-2 py-2 text-right">Credit</th>
              <th class="px-2 py-2 text-right">Adj.</th>
              <th class="px-2 py-2 text-right">Adj. Debit</th>
              <th class="px-2 py-2 text-right">Adj. Credit</th>
              <th class="px-2 py-2 text-right">P&L</th>
              <th class="px-2 py-2 text-right">Balance Sheet</th>
            </tr>
          </thead>
          <tbody id="extendedTBBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Balance Sheet -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Balance Sheet</h2>
      <div class="flex gap-2">
        <button id="exportBalanceSheet" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export Balance Sheet</button>
      </div>
    </div>

    <div class="overflow-auto">
      <table id="balanceSheetTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Fiscal Year</th>
            <th class="px-3 py-2 text-right">Assets</th>
            <th class="px-3 py-2 text-right">Liabilities</th>
            <th class="px-3 py-2 text-right">Equity</th>
          </tr>
        </thead>
        <tbody id="balanceSheetBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Asset Lifecycle -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Asset Lifecycle</h2>
    <div class="overflow-auto">
      <table id="assetLifecycleTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Asset</th>
            <th class="px-3 py-2 text-right">Purchase</th>
            <th class="px-3 py-2 text-right">Sale</th>
            <th class="px-3 py-2 text-right">Gain/Loss</th>
            <th class="px-3 py-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody id="assetLifecycleBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Journal: entries expandable to show lines inline -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Journal Entries</h2>
    <div class="overflow-auto">
      <table id="journalEntriesTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2">Entry ID</th>
            <th class="px-3 py-2">Date</th>
            <th class="px-3 py-2">Description</th>
            <th class="px-3 py-2">Lines</th>
          </tr>
        </thead>
        <tbody id="journalEntriesBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Export/Import Journal + Journal Lines -->
  <section class="flex gap-4 mb-12">
    <button id="exportJournalBtn" class="px-4 py-2 bg-green-600 text-white rounded">Export Journal CSV</button>
    <label class="px-4 py-2 bg-yellow-500 text-white rounded cursor-pointer">
      Import Journal CSV
      <input id="importJournalInput" type="file" accept=".csv" class="hidden" />
    </label>
  </section>

  <!-- Drill-down modal (hidden) -->
  <div id="drillDownModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-3xl">
      <div class="flex justify-between items-center mb-3">
        <h3 id="drillDownTitle" class="text-lg font-semibold">Drill-down</h3>
        <button id="closeDrillDown" class="px-3 py-1 bg-gray-200 rounded">Close</button>
      </div>

      <div class="overflow-auto max-h-80">
        <table class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-1">Date</th>
              <th class="px-2 py-1">Reference</th>
              <th class="px-2 py-1">Description</th>
              <th class="px-2 py-1 text-right">Debit</th>
              <th class="px-2 py-1 text-right">Credit</th>
            </tr>
          </thead>
          <tbody id="drillDownBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>
<!-- ======= END REPLACEMENT CONTENT ======= -->

    
<!-- Modal -->
<div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold text-primary-800 mb-4">Add Transaction</h2>
    <form id="transactionForm" class="space-y-4">
      <input id="txnDate" name="date" type="date" required class="w-full px-4 py-2 border rounded-lg" />
      <input id="txnDesc" name="description" type="text" placeholder="Description" required class="w-full px-4 py-2 border rounded-lg" />
      <input id="txnAmount" name="amount" type="number" placeholder="Amount" required class="w-full px-4 py-2 border rounded-lg" />

      <select id="txnType" name="type" required class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Type</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
        <option value="capital_expense">Capital Expense</option>
        <option value="capital_revenue">Capital Revenue</option>
        <option value="liability">Liability</option>
        <option value="asset_sale">Asset Sale</option>
      </select>

      <!-- Transaction Modal -->
<select id="category" name="category" required class="w-full px-4 py-2 border rounded-lg">
  <option value="">Select Category</option>
  <!-- Options will be populated dynamically -->
</select>


      <div class="flex justify-end space-x-2">
        <button type="button" id="cancelModal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700">Add</button>
      </div>
    </form>
  </div>
</div>

 <div id="exportFeedback" class="fixed bottom-6 right-6 bg-primary-600 text-white px-4 py-2 rounded-lg shadow-lg hidden transition-opacity duration-500"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --------------------------
  // Config & Helpers
  // --------------------------
  const nf = new Intl.NumberFormat("en-ZM", { style: "currency", currency: "ZMW", minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const num = v => (typeof v === "number" ? v : (parseFloat(v) || 0));

  function formatMoney(v) { return nf.format(num(v)); }
  function showToast(msg, ms = 2400) {
    let el = document.getElementById("exportFeedback");
    if (!el) {
      el = document.createElement("div");
      el.id = "exportFeedback";
      el.className = "fixed bottom-6 right-6 bg-primary-600 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-500";
      document.body.appendChild(el);
    }
    el.textContent = msg; el.classList.remove("hidden"); el.style.opacity = "1";
    setTimeout(() => { el.style.opacity = "0"; setTimeout(() => el.classList.add("hidden"), 400); }, ms);
  }

  // Null-safe DOM getter
  const $ = id => document.getElementById(id);

  // --------------------------
  // DOM references (existing)
  // --------------------------
  const modal = $("transactionModal");
  const openModalBtn = $("openModal");
  const cancelModalBtn = $("cancelModal");
  const form = $("transactionForm");
  const txnType = $("txnType");
  const categorySelect = $("category");
  const transactionBody = $("transactionBody");
  const trialBalanceBody = $("trialBalanceBody");
  const balanceSheetBody = $("balanceSheetBody");
  const assetLifecycleBody = $("assetLifecycleBody");
  const journalEntriesTbody = document.querySelector("#journalEntriesTable tbody");
  const journalLinesTbody = document.querySelector("#journalLinesTable tbody");
  const startDateInput = $("startDate");
  const endDateInput = $("endDate");
  const reportTypeSelect = $("reportType");

  const revenueEl = $("totalRevenue");
  const expensesEl = $("totalExpenses");
  const profitEl = $("netProfit");
  const capexEl = $("totalCapex");
  const caprevEl = $("totalCaprev");
  const liabilitiesEl = $("totalLiabilities");

  // --------------------------
  // State
  // --------------------------
  let chartOfAccounts = [];
  let transactions = [];
  let journals = { entries: [], lines: [] };
  let trialBalance = [];
  let balanceSheet = [];
  let assets = [];
  let lineChart = null;
  let pieChart = null;

  // --------------------------
  // Create drill modal (if not present)
  // --------------------------
  function ensureDrillModal() {
    let m = $("drillModal");
    if (m) return m;
    m = document.createElement("div");
    m.id = "drillModal";
    m.className = "fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-60";
    m.innerHTML = `
      <div class="bg-white rounded-xl p-6 w-full max-w-2xl">
        <h3 id="drillTitle" class="text-lg font-semibold mb-4">Details</h3>
        <div id="drillBody" class="max-h-72 overflow-auto mb-4"></div>
        <div class="flex justify-end gap-2">
          <button id="closeDrill" class="px-4 py-2 bg-gray-200 rounded">Close</button>
        </div>
      </div>`;
    document.body.appendChild(m);
    $("closeDrill").addEventListener("click", () => m.classList.add("hidden"));
    return m;
  }

  // --------------------------
  // Load Chart of Accounts
  // --------------------------
  async function loadChartOfAccounts() {
    try {
      const res = await fetch("/api/finance/chart_of_accounts");
      const json = await res.json();
      chartOfAccounts = json.data || [];
    } catch (err) {
      console.error("Failed to load COA:", err);
      chartOfAccounts = []; // fallback
    }
  }

  // --------------------------
  // Modal control for Add Transaction
  // --------------------------
  openModalBtn?.addEventListener("click", async () => {
    if (!chartOfAccounts.length) await loadChartOfAccounts();
    // populate categories with full list by default
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    (chartOfAccounts || []).forEach(acc => {
      const opt = document.createElement("option");
      opt.value = acc.account_id; // account id numeric
      opt.dataset.name = acc.name || "";
      opt.textContent = `${acc.code || ""} - ${acc.name || acc.account_id}`;
      categorySelect.appendChild(opt);
    });
    modal?.classList.remove("hidden");
    form?.reset();
  });
  cancelModalBtn?.addEventListener("click", () => { modal?.classList.add("hidden"); form?.reset(); });
  modal?.addEventListener("click", (e) => { if (e.target === modal) { modal.classList.add("hidden"); } });

  // When txn type changes, filter categories accordingly
  txnType?.addEventListener("change", () => {
    const t = txnType.value;
    const typeMap = {
      income: "revenue",
      capital_revenue: "revenue",
      expense: "expense",
      capital_expense: "expense",
      liability: "liability",
      asset_sale: "asset"
    };
    const wanted = typeMap[t];
    categorySelect.innerHTML = '<option value="">Select Category</option>';
    (chartOfAccounts || []).filter(a => a.type === wanted).forEach(acc => {
      const opt = document.createElement("option");
      opt.value = acc.account_id;
      opt.dataset.name = acc.name;
      opt.textContent = `${acc.code || ""} - ${acc.name}`;
      categorySelect.appendChild(opt);
    });
  });

  // --------------------------
  // Submit transaction (sends both account_id and category name)
  // --------------------------
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {
      date: fd.get("date"),
      description: fd.get("description"),
      amount: num(fd.get("amount")),
      type: fd.get("type"),
      account_id: fd.get("category") ? parseInt(fd.get("category")) : null,
    };
    // also include category name to support server expecting name OR id
    const selectedOpt = categorySelect.selectedOptions?.[0];
    payload.category = selectedOpt ? (selectedOpt.dataset.name || selectedOpt.textContent) : null;

    if (!payload.date || !payload.description || !payload.amount || !payload.type || !payload.account_id) {
      return alert("Please complete all required fields (including category).");
    }

    try {
      const res = await fetch("/api/finance/transactions", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || json.message || "Failed to add");
      showToast("Transaction saved");
      form.reset();
      modal.classList.add("hidden");
      await loadTransactions(); // refresh
    } catch (err) {
      console.error("Error adding transaction:", err);
      alert("Failed to add transaction: " + (err.message || err));
    }
  });

  // --------------------------
  // Fetch / Filter by Period
  // --------------------------
  async function loadTransactions(periodStart = null, periodEnd = null) {
    try {
      const res = await fetch("/api/finance/transactions");
      const json = await res.json();
      transactions = json.data || [];

      // If period provided, filter by created/posted date or transaction date
      let filtered = transactions;
      if (periodStart || periodEnd) {
        const start = periodStart ? new Date(periodStart) : null;
        const end = periodEnd ? new Date(periodEnd) : null;
        filtered = transactions.filter(tx => {
          const d = new Date(tx.date);
          return (!start || d >= start) && (!end || d <= end);
        });
      }
      renderTransactionTable(filtered);
      updateSummary(filtered);
      updateCharts(filtered);
    } catch (err) {
      console.error("Load transactions failed:", err);
    }
  }

  // wire period filter UI (if present)
  if (startDateInput && endDateInput) {
    // refresh when either changes
    [startDateInput, endDateInput].forEach(inp =>
      inp.addEventListener("change", () => loadTransactions(startDateInput.value || null, endDateInput.value || null))
    );
  }

  // --------------------------
  // Render Transaction Table (with Reference/PaymentMethod/Status)
  // --------------------------
  function renderTransactionTable(data = []) {
    if (!transactionBody) return;
    transactionBody.innerHTML = "";
    data.forEach(tx => {
      const ref = tx.reference || (tx.transaction_id ? `TXN-${tx.transaction_id}` : "-");
      const pm = tx.payment_method || tx.paymentMethod || "-";
      const st = tx.status || "posted";
      transactionBody.innerHTML += `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-2">${tx.date}</td>
          <td class="px-4 py-2">${tx.description}</td>
          <td class="px-4 py-2">${tx.category_name || tx.category || "-"}</td>
          <td class="px-4 py-2 text-right">${formatMoney(tx.amount)}</td>
          <td class="px-4 py-2">${tx.type}</td>
          <td class="px-4 py-2">${ref}</td>
          <td class="px-4 py-2">${pm}</td>
          <td class="px-4 py-2">${st}</td>
        </tr>`;
    });
  }

  // --------------------------
  // Charts: stable sizing + update
  // --------------------------
  function initCharts() {
    const lineCanvas = document.getElementById("lineChart");
    const pieCanvas = document.getElementById("pieChart");
    if (!lineCanvas || !pieCanvas) return;

    // stable pixel heights to avoid runaway growth
    lineCanvas.style.height = "300px";
    pieCanvas.style.height = "300px";

    const lc = lineCanvas.getContext("2d");
    const pc = pieCanvas.getContext("2d");

    if (lineChart) lineChart.destroy();
    if (pieChart) pieChart.destroy();

    lineChart = new Chart(lc, {
      type: "line",
      data: { labels: [], datasets: [
        { label: "Revenue", data: [], borderColor: "#10b981", backgroundColor: "rgba(16,185,129,0.12)", fill: true, tension: 0.3 },
        { label: "Expenses", data: [], borderColor: "#ef4444", backgroundColor: "rgba(239,68,68,0.12)", fill: true, tension: 0.3 }
      ]},
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
    });

    pieChart = new Chart(pc, {
      type: "pie",
      data: { labels: [], datasets: [{ data: [], backgroundColor: ["#fbbf24","#f87171","#60a5fa","#34d399","#c084fc"] }]},
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } } }
    });
  }

  function updateCharts(data = []) {
    if (!lineChart || !pieChart) return;

    const monthly = {};
    data.forEach(tx => {
      const m = tx.date ? tx.date.slice(0,7) : "unknown";
      monthly[m] = monthly[m] || { income: 0, expense: 0 };
      if (["income","capital_revenue"].includes(tx.type)) monthly[m].income += num(tx.amount);
      if (["expense","capital_expense"].includes(tx.type)) monthly[m].expense += num(tx.amount);
    });

    const months = Object.keys(monthly).sort();
    lineChart.data.labels = months;
    lineChart.data.datasets[0].data = months.map(m => monthly[m].income);
    lineChart.data.datasets[1].data = months.map(m => monthly[m].expense);
    lineChart.update();

    const catMap = {};
    data.filter(tx => ["expense","capital_expense"].includes(tx.type)).forEach(tx => {
      const name = tx.category_name || tx.category || "Unknown";
      catMap[name] = (catMap[name] || 0) + num(tx.amount);
    });

    pieChart.data.labels = Object.keys(catMap);
    pieChart.data.datasets[0].data = Object.values(catMap);
    pieChart.update();
  }

  // --------------------------
  // Summary Cards update
  // --------------------------
  function updateSummary(data = []) {
    const totals = { income: 0, expenses: 0, capex: 0, caprev: 0, liabilities: 0, cashflow: 0, equity: 0, workingCapital: 0 };
    data.forEach(tx => {
      const a = num(tx.amount);
      if (["income","capital_revenue"].includes(tx.type)) totals.income += a;
      if (["expense","capital_expense"].includes(tx.type)) totals.expenses += a;
      if (tx.type === "capital_expense") totals.capex += a;
      if (tx.type === "capital_revenue") totals.caprev += a;
      if (tx.type === "liability") totals.liabilities += a;
    });

    // basic derived metrics (placeholders — replace with true formulae if available)
    totals.cashflow = totals.income - totals.expenses;
    totals.equity = (balanceSheet[0]?.equity) ? num(balanceSheet[0].equity) : (totals.caprev - totals.capex);
    totals.workingCapital = (balanceSheet[0] && balanceSheet[0].assets !== undefined && balanceSheet[0].liabilities !== undefined) ? (num(balanceSheet[0].assets) - num(balanceSheet[0].liabilities)) : 0;

    revenueEl && (revenueEl.textContent = formatMoney(totals.income));
    expensesEl && (expensesEl.textContent = formatMoney(totals.expenses));
    profitEl && (profitEl.textContent = formatMoney(totals.income - totals.expenses));
    capexEl && (capexEl.textContent = formatMoney(totals.capex));
    caprevEl && (caprevEl.textContent = formatMoney(totals.caprev));
    liabilitiesEl && (liabilitiesEl.textContent = formatMoney(totals.liabilities));
  }

  // --------------------------
  // Trial Balance, ETB, Balance Sheet & Assets loaders & ETB validation
  // --------------------------
  async function loadTrialBalanceAndETB() {
    try {
      const res = await fetch("/api/finance/trial-balance");
      const json = await res.json();
      trialBalance = json.data || [];

      // Render main TB table
      if (trialBalanceBody) {
        trialBalanceBody.innerHTML = "";
        trialBalance.forEach(r => {
          trialBalanceBody.innerHTML += `<tr>
            <td class="px-4 py-2">${r.account}</td>
            <td class="px-4 py-2 text-right">${formatMoney(r.debit)}</td>
            <td class="px-4 py-2 text-right">${formatMoney(r.credit)}</td>
            <td class="px-4 py-2">${r.fiscal_year || ""}</td>
          </tr>`;
        });
      }

      // Validate total debits vs credits
      const totals = trialBalance.reduce((acc, r) => { acc.debit += num(r.debit); acc.credit += num(r.credit); return acc; }, { debit:0, credit:0});
      const diff = Math.abs(totals.debit - totals.credit);

      // Extended Trial Balance (ETB) rendering: group by account, show balance
      renderExtendedTrialBalance(trialBalance);

      if (diff > 0.005) {
        console.warn("Trial Balance mismatch: debits and credits do not balance.", totals);
        showToast(`TB imbalance detected: ${formatMoney(diff)}`, 4000);
      }

    } catch (err) {
      console.error("Failed to load trial balance:", err);
    }
  }

  function renderExtendedTrialBalance(tbRows) {
    // Create or reuse ETB container
    let etbContainer = $("extendedTrialBalance");
    if (!etbContainer) {
      etbContainer = document.createElement("div");
      etbContainer.id = "extendedTrialBalance";
      etbContainer.className = "bg-white rounded-xl shadow-md p-6 my-4 mx-6";
      // place after trial balance section if present
      const ref = trialBalanceBody?.closest("section") || document.body;
      ref.parentNode.insertBefore(etbContainer, ref.nextSibling);
    }

    // aggregate balances
    const map = {};
    tbRows.forEach(r => {
      const key = r.account;
      map[key] = map[key] || { debit:0, credit:0 };
      map[key].debit += num(r.debit);
      map[key].credit += num(r.credit);
    });

    const rows = Object.keys(map).map(account => {
      const d = map[account].debit; const c = map[account].credit;
      const balance = d - c;
      const balType = balance >= 0 ? "Dr" : "Cr";
      return `<tr>
        <td class="px-4 py-2">${account}</td>
        <td class="px-4 py-2 text-right">${formatMoney(d)}</td>
        <td class="px-4 py-2 text-right">${formatMoney(c)}</td>
        <td class="px-4 py-2 text-right">${formatMoney(Math.abs(balance))} ${balType}</td>
      </tr>`;
    }).join("");

    etbContainer.innerHTML = `<h3 class="text-lg font-semibold mb-3">Extended Trial Balance (ETB)</h3>
      <div class="overflow-x-auto"><table class="w-full text-sm">
        <thead class="bg-gray-100"><tr>
          <th class="px-4 py-2">Account</th>
          <th class="px-4 py-2">Debit</th>
          <th class="px-4 py-2">Credit</th>
          <th class="px-4 py-2">Balance</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table></div>`;
  }

  async function loadBalanceSheet() {
    try {
      const res = await fetch("/api/finance/balance-sheet");
      const json = await res.json();
      balanceSheet = json.data || [];
      if (balanceSheetBody) {
        balanceSheetBody.innerHTML = "";
        balanceSheet.forEach(b => {
          balanceSheetBody.innerHTML += `<tr>
            <td class="px-4 py-2">${b.fiscal_year}</td>
            <td class="px-4 py-2 text-right">${formatMoney(b.assets)}</td>
            <td class="px-4 py-2 text-right">${formatMoney(b.liabilities)}</td>
            <td class="px-4 py-2 text-right">${formatMoney(b.equity)}</td>
          </tr>`;
        });
      }
    } catch (err) {
      console.error("Failed to load balance sheet:", err);
    }
  }

  async function loadAssets() {
    try {
      const res = await fetch("/api/finance/assets");
      const json = await res.json();
      assets = json.data || [];
      if (assetLifecycleBody) {
        assetLifecycleBody.innerHTML = "";
        assets.forEach(a => {
          assetLifecycleBody.innerHTML += `<tr>
            <td class="px-4 py-2">${a.category}</td>
            <td class="px-4 py-2 text-right">${formatMoney(a.purchase)}</td>
            <td class="px-4 py-2 text-right">${formatMoney(a.sale)}</td>
            <td class="px-4 py-2 text-right">${formatMoney(a.gain_loss)}</td>
            <td class="px-4 py-2">${a.status}</td>
          </tr>`;
        });
      }
    } catch (err) {
      console.error("Failed to load assets:", err);
    }
  }

  // --------------------------
  // Journal Entries + Expand inline
  // --------------------------
  async function loadJournalEntries() {
    try {
      const res = await fetch("/api/finance/journal-entries");
      const json = await res.json();
      journals.entries = json.data || [];
      renderJournalEntries();
    } catch (err) {
      console.error("Journal entries load error:", err);
    }
  }

  async function loadJournalLines() {
    try {
      const res = await fetch("/api/finance/journal-lines");
      const json = await res.json();
      journals.lines = json.data || [];
      renderJournalLines(); // full list view (if needed)
    } catch (err) {
      console.error("Journal lines load error:", err);
    }
  }

  function renderJournalEntries() {
    if (!journalEntriesTbody) return;
    journalEntriesTbody.innerHTML = "";
    journals.entries.forEach(entry => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-4 py-2 border">${entry.entry_id}</td>
        <td class="px-4 py-2 border">${entry.date}</td>
        <td class="px-4 py-2 border">${entry.description}</td>
        <td class="px-4 py-2 border text-right"><button class="inline-expand px-2 py-1 bg-gray-100 rounded" data-entry="${entry.entry_id}">Toggle Lines</button></td>
      `;
      journalEntriesTbody.appendChild(tr);
      // placeholder row for expansion
      const expRow = document.createElement("tr");
      expRow.className = "journal-lines-row hidden";
      expRow.dataset.entry = entry.entry_id;
      expRow.innerHTML = `<td colspan="4" class="px-4 py-2 border"><div class="journal-lines-container"></div></td>`;
      journalEntriesTbody.appendChild(expRow);
    });

    // attach expand handlers
    journalEntriesTbody.querySelectorAll(".inline-expand").forEach(btn => {
      btn.addEventListener("click", (ev) => {
        const entryId = ev.currentTarget.dataset.entry;
        const row = journalEntriesTbody.querySelector(`tr.journal-lines-row[data-entry="${entryId}"]`);
        if (!row) return;
        if (row.classList.contains("hidden")) {
          // populate lines
          const container = row.querySelector(".journal-lines-container");
          const lines = journals.lines.filter(l => String(l.entry_id) === String(entryId));
          container.innerHTML = lines.length ? `<table class="w-full text-sm">
              <thead class="bg-gray-100"><tr><th>Line ID</th><th>Account</th><th>Debit</th><th>Credit</th></tr></thead>
              <tbody>${lines.map(l => `<tr><td>${l.line_id}</td><td>${l.account}</td><td class="text-right">${formatMoney(l.debit)}</td><td class="text-right">${formatMoney(l.credit)}</td></tr>`).join("")}</tbody>
            </table>` : `<div class="text-sm text-gray-600">No lines found</div>`;
          row.classList.remove("hidden");
        } else {
          row.classList.add("hidden");
        }
      });
    });
  }

  function renderJournalLines() {
    if (!journalLinesTbody) return;
    journalLinesTbody.innerHTML = "";
    journals.lines.forEach(l => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="px-4 py-2 border">${l.line_id}</td>
        <td class="px-4 py-2 border">${l.entry_id}</td>
        <td class="px-4 py-2 border">${l.account}</td>
        <td class="px-4 py-2 border text-right">${formatMoney(l.debit)}</td>
        <td class="px-4 py-2 border text-right">${formatMoney(l.credit)}</td>`;
      journalLinesTbody.appendChild(tr);
    });
  }

  // --------------------------
  // Drill-down: show transactions composing a category total
  // --------------------------
  function openDrillDown(categoryName) {
    const m = ensureDrillModal();
    const container = $("drillBody");
    const rows = transactions.filter(tx => (tx.category_name || tx.category) === categoryName);
    container.innerHTML = rows.length ? `<table class="w-full text-sm">
      <thead class="bg-gray-100"><tr><th>Date</th><th>Description</th><th class="text-right">Amount</th><th>Type</th></tr></thead>
      <tbody>${rows.map(r => `<tr><td>${r.date}</td><td>${r.description}</td><td class="text-right">${formatMoney(r.amount)}</td><td>${r.type}</td></tr>`).join("")}</tbody>
    </table>` : `<div class="text-sm text-gray-600">No transactions</div>`;
    $("drillTitle").textContent = `Transactions for: ${categoryName}`;
    m.classList.remove("hidden");
  }

  // --------------------------
  // EXPORT helpers: CSV / Excel / PDF
  // --------------------------
  function arrayToCSV(rows) {
    return rows.map(r => r.map(c => `"${String(c).replace(/"/g,"'")}"`).join(",")).join("\n");
  }

  function exportJSONToExcel(json, filename = "data.xlsx") {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(json);
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, filename);
  }

  async function exportTablePDF(head, bodyRows, filename = "report.pdf", title = "Report") {
    const { jsPDF } = window.jspdf || window.jspdf;
    const doc = new jsPDF({ orientation: "portrait", unit: "pt" });
    doc.text(title, 40, 40);
    // head summary horizontal display (small)
    let y = 60;
    head.forEach((h, i) => {
      doc.setFontSize(10);
      doc.text(h.label + ": " + h.value, 40 + i * 140, y);
    });
    // autoTable body if available
    if (doc.autoTable && bodyRows.length) {
      doc.autoTable({ head: [bodyRows.head], body: bodyRows.body, startY: y + 30, styles: { fontSize: 9 } });
    } else {
      // fallback: basic text
      let sy = y + 30;
      bodyRows.body.forEach(row => { doc.text(row.join(" | "), 40, sy); sy += 12; });
    }
    doc.save(filename);
  }

  // specific exports
  $("exportJournalBtn")?.addEventListener("click", () => {
    // export entries and lines as CSVs
    const entriesRows = [["entry_id","date","description"], ...journals.entries.map(e => [e.entry_id,e.date,e.description])];
    const linesRows = [["line_id","entry_id","account","debit","credit"], ...journals.lines.map(l => [l.line_id,l.entry_id,l.account,l.debit,l.credit])];
    const blob1 = new Blob([arrayToCSV(entriesRows)], { type: "text/csv" });
    const a1 = document.createElement("a"); a1.href = URL.createObjectURL(blob1); a1.download = "journal_entries.csv"; a1.click();
    const blob2 = new Blob([arrayToCSV(linesRows)], { type: "text/csv" });
    const a2 = document.createElement("a"); a2.href = URL.createObjectURL(blob2); a2.download = "journal_lines.csv"; a2.click();
    showToast("Journal exported");
  });

  // Export ETB / TB / Balance sheet
  $("exportExcel")?.addEventListener("click", () => {
    exportJSONToExcel(transactions, "transactions.xlsx"); showToast("Transactions Excel exported");
  });
  // additional buttons for TB / ETB / Balance sheet PDF/Excel
  // export ETB
  function exportETB() {
    // ETB rows
    const rows = Object.keys(trialBalance.reduce((m, r) => {
      m[r.account] = m[r.account] || { debit:0, credit:0 };
      m[r.account].debit += num(r.debit); m[r.account].credit += num(r.credit);
      return m;
    }, {})).map(account => {
      const r = trialBalance.find(x => x.account === account) || {debit:0, credit:0};
      return { account, debit: r.debit || 0, credit: r.credit || 0 };
    });
    exportJSONToExcel(rows, "extended_trial_balance.xlsx");
    showToast("Extended Trial Balance exported");
  }

  // wire additional export triggers if DOM buttons exist
  $("exportJournalBtn") && $("exportJournalBtn").addEventListener("click", () => { /* already wired above */ });
  // example: hook ETB export to exportJournalBtn alt-click? We'll add a dedicated button id="exportETBBtn" if present:
  $("exportETBBtn")?.addEventListener("click", exportETB);

  // --------------------------
  // initial load
  // --------------------------
  initCharts();
  loadChartOfAccounts();
  loadTransactions();
  loadTrialBalanceAndETB();
  loadBalanceSheet();
  loadAssets();
  loadJournalEntries();
  loadJournalLines();

  // Expose some utilities globally for debugging / manual use
  window.financeAPI = {
    reloadAll: () => {
      initCharts();
      loadChartOfAccounts();
      loadTransactions();
      loadTrialBalanceAndETB();
      loadBalanceSheet();
      loadAssets();
      loadJournalEntries();
      loadJournalLines();
    },
    openDrillDown
  };

  // --------------------------
  // Attach drill-down on pie slices (category click)
  // --------------------------
  // chart.js doesn't provide DOM click for slices by default; attach interaction via chart event
  if (pieChart) {
    // nothing to do here until pieChart is created; updateCharts will populate
  }

  // clickable rows: allow clicking a transaction category cell to open drill-down
  transactionBody?.addEventListener("click", (e) => {
    const td = e.target.closest("td");
    if (!td) return;
    const tr = td.closest("tr");
    const cells = Array.from(tr.children);
    // find category column (3rd cell in our render)
    const categoryCell = cells[2];
    if (categoryCell && categoryCell.contains(td)) {
      openDrillDown(categoryCell.textContent.trim());
    }
  });

});
</script>
</body>
</html>
