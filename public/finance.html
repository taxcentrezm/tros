<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINANCE Management - EnterpriseERP</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            blue: '#3b82f6',
                            indigo: '#6366f1',
                            cyan: '#06b6d4',
                            emerald: '#10b981',
                            amber: '#f59e0b',
                            rose: '#f43f5e'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body class="bg-gray-50 font-sans antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 relative z-10">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-600 to-primary-800 rounded-lg flex items-center justify-center">
                        <i data-feather="grid" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-semibold text-primary-900">SMAIT ERP</span>
                </div>
                
                <div class="hidden lg:flex space-x-1">
                    <a href="index.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Dashboard</a>
                    <a href="hr.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">HR</a>
                    <a href="inventory.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Inventory</a>
                    <a href="finance.html" class="px-4 py-2 text-primary-700 bg-primary-100 rounded-lg transition-colors font-medium">Finance</a>
                    <a href="sales.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Sales & CRM</a>
                    <a href="reports.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Reports</a>
                    <a href="payroll.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Payroll</a>
                    <a href="salaries.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Salaries</a>
                     <a href="loans.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Loans</a>
                     <a href="employee.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Employees</a>
                    <a href="fiscal.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Fiscal</a>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                            <i data-feather="bell" class="w-5 h-5 text-primary-600"></i>
                        </button>
                        <span class="absolute -top-1 -right-1 bg-accent-rose text-white text-xs rounded-full w-5 h-5 flex items-center justify-center border-2 border-white">3</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-primary-700 rounded-full flex items-center justify-center shadow-sm">
                            <i data-feather="user" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="hidden md:block">
                            <p class="text-sm font-medium text-primary-900">Admin User</p>
                            <p class="text-xs text-primary-500">System Administrator</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

 <!-- ======= REPLACE MAIN CONTENT WITH THIS ENHANCED FINANCE LAYOUT ======= -->
<div class="max-w-7xl mx-auto p-6">

  <!-- Page header + Period filter -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold">Finance Dashboard</h1>
      <p class="text-sm text-gray-600">Overview, drill-downs and extended trial balance.</p>
    </div>

    <!-- Period filter -->
    <form id="periodForm" class="flex gap-2 items-center">
      <label class="text-sm text-gray-600">Period:</label>
      <input id="startDate" type="date" class="px-3 py-2 border rounded" />
      <span class="text-sm text-gray-500">to</span>
      <input id="endDate" type="date" class="px-3 py-2 border rounded" />
      <button type="submit" class="ml-2 px-4 py-2 bg-primary-600 text-white rounded">Apply</button>
      <button id="clearPeriod" type="button" class="ml-2 px-3 py-2 bg-gray-100 rounded text-sm">Clear</button>
    </form>
  </div>

  <!-- Summary Cards (rearranged, professional) -->
  <section class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Revenue</p>
      <h3 id="totalRevenue" class="text-2xl font-bold text-green-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Expenses</p>
      <h3 id="totalExpenses" class="text-2xl font-bold text-red-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Net Profit</p>
      <h3 id="netProfit" class="text-2xl font-bold text-blue-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Cash Flow (Operating)</p>
      <h3 id="cashFlowOperating" class="text-2xl font-bold text-emerald-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Equity</p>
      <h3 id="equityTotal" class="text-2xl font-bold text-purple-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Working Capital</p>
      <h3 id="workingCapital" class="text-2xl font-bold text-yellow-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Capital Expenses (CapEx)</p>
      <h3 id="totalCapex" class="text-2xl font-bold text-orange-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Capital Revenue (CapRev)</p>
      <h3 id="totalCaprev" class="text-2xl font-bold text-indigo-600">ZMW 0.00</h3>
    </div>

    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-600">Total Liabilities</p>
      <h3 id="totalLiabilities" class="text-2xl font-bold text-pink-600">ZMW 0.00</h3>
    </div>
  </section>

  <!-- Charts: two rows -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="font-semibold mb-3">Monthly Revenue vs Expenses</h2>
    <div class="chart-container h-[300px]">
      <canvas id="lineChart"></canvas>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="font-semibold mb-3">Expense Breakdown</h2>
    <div class="chart-container h-[300px]">
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="font-semibold mb-3">Net Profit Trend</h2>
    <div class="chart-container h-[300px]">
      <canvas id="netProfitTrend"></canvas>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-6">
    <h2 class="font-semibold mb-3">Liabilities vs Assets</h2>
    <div class="chart-container h-[300px]">
      <canvas id="liabilitiesAssetsChart"></canvas>
    </div>
  </div>
</section>

<style>
  /* Force fixed height and prevent charts from expanding */
  .chart-container {
    position: relative;
    width: 100%;
    max-height: 300px;
    overflow: hidden;
  }

  canvas {
    width: 100% !important;
    height: 100% !important;
  }

    
/* Nested lines table container animation */
.lines-container {
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.35s ease-out, opacity 0.35s ease-out;
  opacity: 0;
}

.lines-container.open {
  max-height: 500px; /* large enough to fit most entries */
  opacity: 1;
}

    .lines-container {
  transition: max-height 0.3s ease-in-out;
}
.lines-container.open {
  overflow: visible;
}

</style>


  <!-- Transactions Table with richer details + export buttons -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Transactions</h2>
  
      <div class="flex gap-2">
        <input id="transactionSearch" type="text" placeholder="Search..." class="px-3 py-2 border rounded" />
          <button 
    class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 transition"
    onclick="openTransactionModal()">
    + Add Transaction
  </button>
        <button id="importBtn" class="px-3 py-2 bg-purple-600 text-white rounded">Import</button>
        <button id="exportCSV" class="px-3 py-2 bg-blue-600 text-white rounded">Export CSV</button>
        <button id="exportExcel" class="px-3 py-2 bg-green-600 text-white rounded">Export Excel</button>
        <button id="exportPDF" class="px-3 py-2 bg-red-600 text-white rounded">Export PDF</button>
      </div>
    </div>

    <div class="overflow-auto">
     <table id="transactionTable" class="w-full text-sm">
  <thead class="bg-gray-100">
    <tr>
      <th class="px-3 py-2 text-left">Date</th>
      <th class="px-3 py-2 text-left">Description</th>
      <th class="px-3 py-2 text-left">Category</th>
      <th class="px-3 py-2 text-left">Type</th>
      <th class="px-3 py-2 text-left">Account</th>
      <th class="px-3 py-2 text-right">Amount</th>
      <th class="px-3 py-2 text-right">Action</th>
    </tr>
  </thead>
  <tbody id="transactionBody" class="divide-y divide-gray-200"></tbody>
</table>
    </div>
  </section>

  <!-- Balance & Extended Trial Balance -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Trial Balance</h2>
        <div class="flex gap-2">
         <button id="exportTB" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Export TB</button>
          <button id="validateLedger" class="px-3 py-2 bg-yellow-500 text-white rounded text-sm">Validate Ledger</button>
        </div>
      </div>
      <div class="overflow-auto">
        <table id="trialBalanceTable" class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">Account</th>
              <th class="px-3 py-2 text-right">Debit</th>
              <th class="px-3 py-2 text-right">Credit</th>
              <th class="px-3 py-2 text-right">Balance</th>
            </tr>
          </thead>
          <tbody id="trialBalanceBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <p id="ledgerCheck" class="mt-3 text-sm"></p>
    </div>

    <div class="bg-white rounded-xl shadow p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Extended Trial Balance (ETB)</h2>
        <button id="exportETB" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export ETB</button>
      </div>

      <div class="overflow-auto">
        <table id="extendedTrialBalanceTable" class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 text-left">Account</th>
              <th class="px-2 py-2 text-right">Debit</th>
              <th class="px-2 py-2 text-right">Credit</th>
              <th class="px-2 py-2 text-right">Adj.</th>
              <th class="px-2 py-2 text-right">Adj. Debit</th>
              <th class="px-2 py-2 text-right">Adj. Credit</th>
              <th class="px-2 py-2 text-right">P&L</th>
              <th class="px-2 py-2 text-right">Balance Sheet</th>
            </tr>
          </thead>
          <tbody id="extendedTrialBalanceBody" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Balance Sheet -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Balance Sheet</h2>
      <div class="flex gap-2">
        <button id="exportBalanceSheet" class="px-3 py-2 bg-gray-800 text-white rounded text-sm">Export Balance Sheet</button>
      </div>
    </div>

    <div class="overflow-auto">
      <table id="balanceSheetTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Fiscal Year</th>
            <th class="px-3 py-2 text-right">Assets</th>
            <th class="px-3 py-2 text-right">Liabilities</th>
            <th class="px-3 py-2 text-right">Equity</th>
          </tr>
        </thead>
        <tbody id="balanceSheetBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Asset Lifecycle -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Asset Lifecycle</h2>
    <div class="overflow-auto">
      <table id="assetLifecycleTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 text-left">Asset</th>
            <th class="px-3 py-2 text-right">Purchase</th>
            <th class="px-3 py-2 text-right">Sale</th>
            <th class="px-3 py-2 text-right">Gain/Loss</th>
            <th class="px-3 py-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody id="assetLifecycleBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>

  <!-- Journal: entries expandable to show lines inline -->
  <section class="bg-white rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">Journal Entries</h2>
    <div class="overflow-auto">
      <table id="journalTable" class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2">Entry ID</th>
            <th class="px-3 py-2">Date</th>
            <th class="px-3 py-2">Description</th>
            <th class="px-3 py-2">Lines</th>
          </tr>
        </thead>
        <tbody id="journalBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Export/Import Journal + Journal Lines -->
  <section class="flex gap-4 mb-12">
    <button id="exportJournalBtn" class="px-4 py-2 bg-green-600 text-white rounded">Export Journal CSV</button>
    <label class="px-4 py-2 bg-yellow-500 text-white rounded cursor-pointer">
      Import Journal CSV
      <input id="importJournalInput" type="file" accept=".csv" class="hidden" />
    </label>
  </section>

 <!-- Drill Down Modal -->
<div id="drillDownModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800">Category Details</h2>
      <button id="closeDrillDown" class="text-gray-600 hover:text-gray-900">&times;</button>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left border">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2">Date</th>
            <th class="px-4 py-2">Description</th>
            <th class="px-4 py-2">Amount</th>
            <th class="px-4 py-2">Type</th>
          </tr>
        </thead>
        <tbody id="drillDownBody" class="divide-y"></tbody>
      </table>
    </div>
  </div>
</div>


</div>
<!-- ======= END REPLACEMENT CONTENT ======= -->

    
<!-- Modal -->
<div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold text-primary-800 mb-4">Add Transaction</h2>
    <form id="transactionForm" class="space-y-4">
      <input id="txnDate" name="date" type="date" required class="w-full px-4 py-2 border rounded-lg" />
      <input id="txnDesc" name="description" type="text" placeholder="Description" required class="w-full px-4 py-2 border rounded-lg" />
      <input id="txnAmount" name="amount" type="number" placeholder="Amount" required class="w-full px-4 py-2 border rounded-lg" />

      <select id="txnType" name="type" required class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Type</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
        <option value="capital_expense">Capital Expense</option>
        <option value="capital_revenue">Capital Revenue</option>
        <option value="liability">Liability</option>
        <option value="asset_sale">Asset Sale</option>
      </select>

      <!-- Transaction Modal -->
<select id="category" name="category" required class="w-full px-4 py-2 border rounded-lg">
  <option value="">Select Category</option>
  <!-- Options will be populated dynamically -->
</select>


      <div class="flex justify-end space-x-2">
        <button type="button" id="cancelModal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700">Add</button>
      </div>
    </form>
  </div>
</div>

 <div id="exportFeedback" class="fixed bottom-6 right-6 bg-primary-600 text-white px-4 py-2 rounded-lg shadow-lg hidden transition-opacity duration-500"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const nf = new Intl.NumberFormat("en-ZM", { style: "currency", currency: "ZMW" });

  // =============================
  // 1️⃣ Transaction Modal Logic
  // =============================
  const modal = document.getElementById("transactionModal");
  const openBtn = document.querySelector("button[onclick='openTransactionModal()']");
  const cancelBtn = document.getElementById("cancelModal");
  const form = document.getElementById("transactionForm");

  window.openTransactionModal = () => {
    modal.classList.remove("hidden");
  };

  cancelBtn?.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form).entries());
    try {
      const res = await fetch("/api/finance/transactions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error("Failed to save transaction");
      alert("Transaction added successfully!");
      modal.classList.add("hidden");
      form.reset();
      loadTransactions();
      loadSummary();
    } catch (err) {
      console.error("Add Transaction failed:", err);
      alert("Failed to add transaction.");
    }
  });

  // =============================
  // 2️⃣ Populate Category Dropdown
  // =============================
  async function loadCategories() {
    const select = document.getElementById("category");
    if (!select) return;
    try {
      const res = await fetch("/api/finance/categories");
      if (!res.ok) throw new Error("Categories fetch failed");
      const { data } = await res.json();
      select.innerHTML =
        `<option value="">Select Category</option>` +
        data.map((c) => `<option value="${c.name}">${c.name}</option>`).join("");
    } catch {
      select.innerHTML = `<option value="">Default</option>
        <option value="Sales">Sales</option>
        <option value="Utilities">Utilities</option>
        <option value="Maintenance">Maintenance</option>`;
    }
  }

  // =============================
  // 3️⃣ Load Summary + ETB
  // =============================
  async function loadSummary() {
    try {
      const res = await fetch("/api/finance/summary");
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const { summary, extended_trial_balance } = await res.json();

      if (summary) {
        document.getElementById("totalRevenue").textContent = nf.format(summary.revenue || 0);
        document.getElementById("totalExpenses").textContent = nf.format(summary.expenses || 0);
        document.getElementById("netProfit").textContent = nf.format(summary.net_profit || 0);
        document.getElementById("totalCapex").textContent = nf.format(summary.capex || 0);
        document.getElementById("totalCaprev").textContent = nf.format(summary.caprev || 0);
        document.getElementById("totalLiabilities").textContent = nf.format(summary.liabilities || 0);
      }

      renderExtendedTrialBalance(extended_trial_balance || []);
    } catch (err) {
      console.error("Summary load failed:", err);
    }
  }

  function renderExtendedTrialBalance(etb) {
    const tbody = document.getElementById("extendedTrialBalanceBody");
    if (!tbody) return;
    if (!etb.length) {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center py-2 text-gray-500">No data</td></tr>`;
      return;
    }
    tbody.innerHTML = etb
      .map(
        (r) => `
        <tr>
          <td>${r.account_name}</td>
          <td class="text-right">${nf.format(r.debit || 0)}</td>
          <td class="text-right">${nf.format(r.credit || 0)}</td>
          <td class="text-right">${nf.format(r.adjustments || 0)}</td>
          <td class="text-right">${nf.format(r.closing_balance || 0)}</td>
        </tr>`
      )
      .join("");
  }

  // =============================
  // 4️⃣ Load Transactions
  // =============================
 async function loadTransactions() {
  try {
    const res = await fetch("/api/finance/transactions");
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const { data } = await res.json();

    const tbody = document.getElementById("transactionBody");
    if (!tbody) return;

    if (!data.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-2 text-gray-500">
            No transactions
          </td>
        </tr>`;
      return;
    }

    tbody.innerHTML = data
      .map(
        (tx) => `
          <tr data-entry-id="${tx.id}">
            <td>${tx.date}</td>
            <td>${tx.description || ""}</td>
            <td>${tx.category || ""}</td>
            <td>${tx.type || ""}</td>
            <td>${tx.account || ""}</td>
            <td class="text-right">${nf.format(tx.amount || 0)}</td>
            <td class="text-right">
              <button 
                class="view-lines-btn px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition"
                data-entry='${JSON.stringify(tx)}'>
                View Lines
              </button>
            </td>
          </tr>`
      )
      .join("");

    // Attach button listeners after rendering
    document.querySelectorAll(".view-lines-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const entry = JSON.parse(btn.dataset.entry);
        const clickedRow = btn.closest("tr");
        toggleJournalLines(entry, clickedRow);
      });
    });
  } catch (err) {
    console.error("Transactions load failed:", err);
  }
}



  // =============================
  // 5️⃣ Load Journal Entries + Lines
  // =============================
  async function loadJournalEntries() {
    try {
      const res = await fetch("/api/finance/journal-entries");
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const { data } = await res.json();
      const tbody = document.getElementById("journalBody");
      if (!tbody) return;

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2 text-gray-500">No journal entries</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      data.forEach((entry) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${entry.entry_id || entry.id || "N/A"}</td>
          <td>${entry.date}</td>
          <td>${entry.description}</td>
          <td class="text-center">
            <button class="view-lines-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs hover:bg-blue-200">
              View Lines
            </button>
          </td>`;

        tr.querySelector(".view-lines-btn").addEventListener("click", () =>
          toggleJournalLines(entry.entry_id || entry.id, tr)
        );
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error("Journal load failed:", err);
    }
  }

 async function toggleJournalLines(entry, clickedRow) {
  const entryId = entry.entry_id || entry.id;
  if (!entryId) return console.error("Missing entry_id for journal entry:", entry);

  // If already open → close it
  const existing = document.querySelector(`tr[data-lines='${entryId}']`);
  if (existing) {
    const container = existing.querySelector(".lines-container");
    container.classList.remove("open");
    setTimeout(() => existing.remove(), 250);
    return;
  }

  try {
    // Fetch lines for this entry
    const res = await fetch(`/api/finance/journal-lines?entry_id=${entryId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const { data } = await res.json();

    if (!data || !data.length) {
      console.warn(`No lines found for entry ${entryId}`);
      return;
    }

    // Build lines table
    const linesHTML = data
      .map(
        (l) => `
        <tr>
          <td class="px-2 py-1">${l.account || ""}</td>
          <td class="px-2 py-1 text-right">${nf.format(l.debit || 0)}</td>
          <td class="px-2 py-1 text-right">${nf.format(l.credit || 0)}</td>
        </tr>`
      )
      .join("");

    // Create new detail row
    const tr = document.createElement("tr");
    tr.dataset.lines = entryId;
    tr.innerHTML = `
      <td colspan="4" class="p-0 bg-gray-50">
        <div class="lines-container transition-all duration-300 ease-in-out max-h-0 overflow-hidden">
          <table class="w-full text-sm border-t border-gray-200">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-2 py-1 text-left">Account</th>
                <th class="px-2 py-1 text-right">Debit</th>
                <th class="px-2 py-1 text-right">Credit</th>
              </tr>
            </thead>
            <tbody>${linesHTML}</tbody>
          </table>
        </div>
      </td>
    `;

    // Insert below clicked entry
    clickedRow.parentNode.insertBefore(tr, clickedRow.nextSibling);

    // Animate open
    const container = tr.querySelector(".lines-container");
    requestAnimationFrame(() => {
      container.classList.add("open");
      container.style.maxHeight = container.scrollHeight + "px";
    });
  } catch (err) {
    console.error("Journal lines load failed:", err);
  }
}


  // =============================
  // 6️⃣ Validate Ledger (Trial Balance)
  // =============================
  const validateBtn = document.getElementById("validateLedger");
  validateBtn?.addEventListener("click", () => {
    const tbody = document.getElementById("trialBalanceBody");
    if (!tbody) return alert("No trial balance loaded.");

    let totalDebit = 0;
    let totalCredit = 0;
    tbody.querySelectorAll("tr").forEach((row) => {
      const cells = row.querySelectorAll("td");
      if (cells.length >= 3) {
        totalDebit += parseFloat(cells[1].textContent.replace(/[^0-9.-]+/g, "")) || 0;
        totalCredit += parseFloat(cells[2].textContent.replace(/[^0-9.-]+/g, "")) || 0;
      }
    });

    if (totalDebit.toFixed(2) === totalCredit.toFixed(2)) {
      alert(`✅ Ledger balanced!\nDebit: ${nf.format(totalDebit)}\nCredit: ${nf.format(totalCredit)}`);
    } else {
      alert(`⚠️ Ledger imbalance!\nDebit: ${nf.format(totalDebit)}\nCredit: ${nf.format(totalCredit)}`);
    }
  });

  // =============================
  // Init all data
  // =============================
  loadCategories();
  loadSummary();
  loadTransactions();
  loadJournalEntries();
});
</script>

</html>

































