<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINANCE Management - EnterpriseERP</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            blue: '#3b82f6',
                            indigo: '#6366f1',
                            cyan: '#06b6d4',
                            emerald: '#10b981',
                            amber: '#f59e0b',
                            rose: '#f43f5e'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui']
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body class="bg-gray-50 font-sans antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 shadow-sm">
        <div class="container mx-auto px-4 relative z-10">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-600 to-primary-800 rounded-lg flex items-center justify-center">
                        <i data-feather="grid" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-semibold text-primary-900">SMAIT ERP</span>
                </div>
                
                <div class="hidden lg:flex space-x-1">
                    <a href="index.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Dashboard</a>
                    <a href="hr.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">HR</a>
                    <a href="inventory.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Inventory</a>
                    <a href="finance.html" class="px-4 py-2 text-primary-700 bg-primary-100 rounded-lg transition-colors font-medium">Finance</a>
                    <a href="sales.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Sales & CRM</a>
                    <a href="reports.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Reports</a>
                    <a href="payroll.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Payroll</a>
                    <a href="fiscal.html" class="px-4 py-2 text-primary-700 hover:bg-primary-50 rounded-lg transition-colors font-medium">Fiscal</a>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                            <i data-feather="bell" class="w-5 h-5 text-primary-600"></i>
                        </button>
                        <span class="absolute -top-1 -right-1 bg-accent-rose text-white text-xs rounded-full w-5 h-5 flex items-center justify-center border-2 border-white">3</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-primary-700 rounded-full flex items-center justify-center shadow-sm">
                            <i data-feather="user" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="hidden md:block">
                            <p class="text-sm font-medium text-primary-900">Admin User</p>
                            <p class="text-xs text-primary-500">System Administrator</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

  <!-- Summary Cards -->
<section class="grid grid-cols-1 md:grid-cols-5 gap-6 p-6">
  <!-- Total Revenue -->
  <div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-600">Total Revenue</p>
        <h3 id="totalRevenue" class="text-3xl font-bold text-green-700">$0</h3>
      </div>
      <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
        <i data-feather="dollar-sign" class="text-green-600"></i>
      </div>
    </div>
  </div>

  <!-- Total Expenses -->
  <div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up" data-aos-delay="100">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-600">Total Expenses</p>
        <h3 id="totalExpenses" class="text-3xl font-bold text-red-700">$0</h3>
      </div>
      <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
        <i data-feather="credit-card" class="text-red-600"></i>
      </div>
    </div>
  </div>

  <!-- Net Profit -->
  <div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up" data-aos-delay="200">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-600">Net Profit</p>
        <h3 id="netProfit" class="text-3xl font-bold text-blue-700">$0</h3>
      </div>
      <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
        <i data-feather="bar-chart-2" class="text-blue-600"></i>
      </div>
    </div>
  </div>

  <!-- Capital Expenses -->
  <div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up" data-aos-delay="300">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-600">Capital Expenses (CapEx)</p>
        <h3 id="totalCapex" class="text-3xl font-bold text-orange-700">$0</h3>
      </div>
      <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
        <i data-feather="minus-circle" class="text-orange-600"></i>
      </div>
    </div>
  </div>

  <!-- Total Liabilities -->
<div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up" data-aos-delay="500">
  <div class="flex justify-between items-center">
    <div>
      <p class="text-gray-600">Total Liabilities</p>
      <h3 id="totalLiabilities" class="text-3xl font-bold text-yellow-700">$0</h3>
    </div>
    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
      <i data-feather="alert-circle" class="text-yellow-600"></i>
    </div>
  </div>
</div>


  <!-- Capital Revenue -->
  <div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up" data-aos-delay="400">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-gray-600">Capital Revenue (CapRev)</p>
        <h3 id="totalCaprev" class="text-3xl font-bold text-purple-700">$0</h3>
      </div>
      <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
        <i data-feather="plus-circle" class="text-purple-600"></i>
      </div>
    </div>
  </div>
</section>

  <!-- Charts -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mx-6 mb-12">
    <div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up">
      <h2 class="text-lg font-semibold text-primary-800 mb-4">Monthly Revenue vs Expenses</h2>
      <canvas id="lineChart" height="200"></canvas>
    </div>
    <div class="bg-white rounded-xl shadow-md p-6" data-aos="fade-up" data-aos-delay="100">
      <h2 class="text-lg font-semibold text-primary-800 mb-4">Expense Breakdown</h2>
      <canvas id="pieChart" height="200"></canvas>
    </div>
  </section>

  <!-- Transactions Table -->
  <section class="bg-white rounded-xl shadow-md p-6 mx-6 mb-12" data-aos="fade-up">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-primary-800">Transactions</h2>
      <div class="flex space-x-2 mb-4">
  <input type="file" id="importFile" accept=".csv,.xlsx" class="hidden" />
  <button id="importBtn" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
    Import Transactions
  </button>
  <button id="exportCSV" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Export CSV</button>
  <button id="exportExcel" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Export Excel</button>
  <button id="exportPDF" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Export PDF</button>
</div>
</div>

      <button class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 flex items-center" id="openModal">
        <i data-feather="plus" class="w-5 h-5 mr-2"></i> Add Transaction
      </button>
    </div>
    <input type="text" id="transactionSearch" placeholder="Search..." class="mb-4 w-full px-4 py-2 border rounded-lg" />
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="transactionTable" title="Transactions">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left">Date</th>
            <th class="px-4 py-2 text-left">Description</th>
            <th class="px-4 py-2 text-left">Category</th>
            <th class="px-4 py-2 text-left">Amount</th>
            <th class="px-4 py-2 text-left">Type</th>
          </tr>
        </thead>
        <tbody id="transactionBody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </section>
  <!-- Balance Sheet Section -->
<section class="bg-white rounded-xl shadow-md p-6 mx-6 mb-12" data-aos="fade-up">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold text-primary-800">Balance Sheet</h2>
    <button class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 flex items-center" id="addBalanceSheet">
      <i data-feather="plus" class="w-5 h-5 mr-2"></i> Add Entry
    </button>
  </div>
  <div class="overflow-x-auto">
    <table id="balanceSheetTable" title="Balance Sheet" class="w-full text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">Fiscal Year</th>
          <th class="px-4 py-2 text-left">Assets</th>
          <th class="px-4 py-2 text-left">Liabilities</th>
          <th class="px-4 py-2 text-left">Equity</th>
        </tr>
      </thead>
      <tbody id="balanceSheetBody" class="divide-y divide-gray-200"></tbody>
    </table>
  </div>
</section>

<!-- Trial Balance Section -->
<section class="bg-white rounded-xl shadow-md p-6 mx-6 mb-12" data-aos="fade-up">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-semibold text-primary-800">Trial Balance</h2>
    <button class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 flex items-center" id="addTrialBalance">
      <i data-feather="plus" class="w-5 h-5 mr-2"></i> Add Entry
    </button>
  </div>
  <div class="overflow-x-auto">
    <table id="trialBalanceTable" title="Trial Balance" class="w-full text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">Account</th>
          <th class="px-4 py-2 text-left">Debit</th>
          <th class="px-4 py-2 text-left">Credit</th>
          <th class="px-4 py-2 text-left">Fiscal Year</th>
        </tr>
      </thead>
      <tbody id="trialBalanceBody" class="divide-y divide-gray-200"></tbody>
    </table>
  </div>
</section>

<section class="bg-white rounded-xl shadow-md p-6 mx-6 mb-12" data-aos="fade-up">
  <h2 class="text-xl font-semibold text-primary-800 mb-4">Asset Lifecycle</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm" id="assetLifecycleTable" title="Asset Lifecycle">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 text-left">Asset</th>
          <th class="px-4 py-2 text-left">Purchase</th>
          <th class="px-4 py-2 text-left">Sale</th>
          <th class="px-4 py-2 text-left">Gain/Loss</th>
          <th class="px-4 py-2 text-left">Status</th>
        </tr>
      </thead>
      <tbody id="assetLifecycleBody" class="divide-y divide-gray-200"></tbody>
    </table>
  </div>
</section>

  <!-- Modal -->
  <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
      <h2 class="text-xl font-semibold text-primary-800 mb-4">Add Transaction</h2>
      <form id="transactionForm" class="space-y-4">
        <input type="date" required class="w-full px-4 py-2 border rounded-lg" />
        <input type="text" placeholder="Description" required class="w-full px-4 py-2 border rounded-lg" />
  <select id="category" name="category" required class="w-full px-4 py-2 border rounded-lg">
    <option value="">Loading...</option>
  </select>
        <input type="number" placeholder="Amount" required class="w-full px-4 py-2 border rounded-lg" />
        <select id="txnType" required class="w-full px-4 py-2 border rounded-lg">
  <option value="">Select Type</option>
  <option value="income">Income</option>
  <option value="expense">Expense</option>
  <option value="capital_expense">Capital Expense</option>
  <option value="capital_revenue">Capital Revenue</option>
  <option value="liability">Liability</option>
  <option value="asset_sale">Asset Sale</option>
</select>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelModal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700">Add</button>
        </div>
      </form>
    </div>
  </div>
 <div id="exportFeedback" class="fixed bottom-6 right-6 bg-primary-600 text-white px-4 py-2 rounded-lg shadow-lg hidden transition-opacity duration-500"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
fetch('/api/finance/summary')
  .then(res => res.json())
  .then(data => {
    document.getElementById('totalRevenue').textContent = `$${Number(data.total_revenue).toFixed(2)}`;
    document.getElementById('totalExpenses').textContent = `$${Number(data.total_expenses).toFixed(2)}`;
    document.getElementById('netProfit').textContent = `$${Number(data.net_profit).toFixed(2)}`;
    document.getElementById('totalCapex').textContent = `$${Number(data.total_capex).toFixed(2)}`;
    document.getElementById('totalCaprev').textContent = `$${Number(data.total_caprev).toFixed(2)}`;
    document.getElementById('totalLiabilities').textContent = `$${Number(data.total_liabilities).toFixed(2)}`;
  })
  .catch(err => console.error("❌ Failed to load summary:", err));
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  feather.replace();
  AOS.init();

  const revenueEl = document.getElementById("totalRevenue");
  const expensesEl = document.getElementById("totalExpenses");
  const profitEl = document.getElementById("netProfit");
  const capexEl = document.getElementById("totalCapex");
  const caprevEl = document.getElementById("totalCaprev");
  const liabilitiesEl = document.getElementById("totalLiabilities");

  const transactionBody = document.getElementById("transactionBody");
  const trialBalanceBody = document.getElementById("trialBalanceBody");
  const balanceSheetBody = document.getElementById("balanceSheetBody");
  const assetLifecycleBody = document.getElementById("assetLifecycleBody");

  let lineChartInstance, pieChartInstance;

  // =========================
  // Load Data from APIs
  // =========================
  async function loadTransactions() {
    const res = await fetch("/api/finance/transactions");
    const { data } = await res.json();
    renderTransactions(data);
    updateCharts(data);
    updateSummary(data);
  }

  async function loadTrialBalance() {
    const res = await fetch("/api/finance/trial-balance");
    const { data } = await res.json();
    trialBalanceBody.innerHTML = "";
    data.forEach(entry => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-4 py-2">${entry.account}</td>
        <td class="px-4 py-2">$${Number(entry.debit).toFixed(2)}</td>
        <td class="px-4 py-2">$${Number(entry.credit).toFixed(2)}</td>
        <td class="px-4 py-2">${entry.fiscal_year}</td>
      `;
      trialBalanceBody.appendChild(row);
    });
  }

  async function loadBalanceSheet() {
    const res = await fetch("/api/finance/balance-sheet");
    const { data } = await res.json();
    balanceSheetBody.innerHTML = "";
    data.forEach(entry => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-4 py-2">${entry.fiscal_year}</td>
        <td class="px-4 py-2">$${Number(entry.assets).toFixed(2)}</td>
        <td class="px-4 py-2">$${Number(entry.liabilities).toFixed(2)}</td>
        <td class="px-4 py-2">$${Number(entry.equity).toFixed(2)}</td>
      `;
      balanceSheetBody.appendChild(row);
    });
  }

  async function loadAssets() {
    const res = await fetch("/api/finance/assets");
    const { data } = await res.json();
    assetLifecycleBody.innerHTML = "";
    data.forEach(asset => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-4 py-2">${asset.category}</td>
        <td class="px-4 py-2">$${Number(asset.purchase).toFixed(2)}</td>
        <td class="px-4 py-2">$${Number(asset.sale).toFixed(2)}</td>
        <td class="px-4 py-2">$${Number(asset.gain_loss).toFixed(2)}</td>
        <td class="px-4 py-2">${asset.status}</td>
      `;
      assetLifecycleBody.appendChild(row);
    });
  }

  // =========================
  // Render Transactions
  // =========================
  function renderTransactions(transactions) {
    transactionBody.innerHTML = "";
    transactions.forEach(tx => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-4 py-2">${tx.date}</td>
        <td class="px-4 py-2">${tx.description}</td>
        <td class="px-4 py-2">${tx.category}</td>
        <td class="px-4 py-2">$${Number(tx.amount).toFixed(2)}</td>
        <td class="px-4 py-2">${tx.type}</td>
      `;
      transactionBody.appendChild(row);
    });
  }

  // =========================
  // Charts
  // =========================
  function initCharts() {
    const lineCtx = document.getElementById("lineChart").getContext("2d");
    const pieCtx = document.getElementById("pieChart").getContext("2d");

    lineChartInstance = new Chart(lineCtx, {
      type: "line",
      data: { labels: [], datasets: [
        { label: "Revenue", data: [], borderColor: "#10b981", backgroundColor: "rgba(16,185,129,0.2)", fill: true, tension: 0.4 },
        { label: "Expenses", data: [], borderColor: "#ef4444", backgroundColor: "rgba(239,68,68,0.2)", fill: true, tension: 0.4 }
      ]},
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });

    pieChartInstance = new Chart(pieCtx, {
      type: "pie",
      data: { labels: [], datasets: [{ data: [], backgroundColor: ["#fbbf24","#f87171","#60a5fa","#34d399","#c084fc"] }]},
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });
  }

  function updateCharts(transactions) {
    const monthly = {};
    transactions.forEach(tx => {
      const month = tx.date.slice(0, 7);
      if (!monthly[month]) monthly[month] = { income: 0, expense: 0 };
      if (tx.type === "income") monthly[month].income += tx.amount;
      if (tx.type === "expense") monthly[month].expense += tx.amount;
    });

    const months = Object.keys(monthly).sort();
    lineChartInstance.data.labels = months;
    lineChartInstance.data.datasets[0].data = months.map(m => monthly[m].income);
    lineChartInstance.data.datasets[1].data = months.map(m => monthly[m].expense);
    lineChartInstance.update();

    const categoryMap = {};
    transactions.filter(tx => tx.type === "expense").forEach(tx => {
      categoryMap[tx.category] = (categoryMap[tx.category] || 0) + tx.amount;
    });

    pieChartInstance.data.labels = Object.keys(categoryMap);
    pieChartInstance.data.datasets[0].data = Object.values(categoryMap);
    pieChartInstance.update();
  }

  // =========================
  // Summary Cards
  // =========================
  function updateSummary(transactions) {
    const income = transactions.filter(tx => tx.type === "income").reduce((s, tx) => s + tx.amount, 0);
    const expenses = transactions.filter(tx => tx.type === "expense").reduce((s, tx) => s + tx.amount, 0);
    const capex = transactions.filter(tx => tx.type === "capital_expense").reduce((s, tx) => s + tx.amount, 0);
    const caprev = transactions.filter(tx => tx.type === "capital_revenue").reduce((s, tx) => s + tx.amount, 0);
    const liabilities = transactions.filter(tx => tx.type === "liability").reduce((s, tx) => s + tx.amount, 0);

    revenueEl.textContent = `$${income.toFixed(2)}`;
    expensesEl.textContent = `$${expenses.toFixed(2)}`;
    profitEl.textContent = `$${(income - expenses).toFixed(2)}`;
    capexEl.textContent = `$${capex.toFixed(2)}`;
    caprevEl.textContent = `$${caprev.toFixed(2)}`;
    liabilitiesEl.textContent = `$${liabilities.toFixed(2)}`;
  }

  // =========================
  // Init
  // =========================
  initCharts();
  loadTransactions();
  loadTrialBalance();
  loadBalanceSheet();
  loadAssets();
});
</script>
<script>

// =========================
// Import Transactions
// =========================
document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("importFile").click();
});

document.getElementById("importFile").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  const ext = file.name.split(".").pop().toLowerCase();

  if (ext === "csv") {
    reader.onload = (evt) => {
      const lines = evt.target.result.split("\n").map(l => l.split(","));
      lines.slice(1).forEach(row => {
        if (row.length >= 5) {
          const [date, desc, category, amount, type] = row;
          if (date && amount && type) {
            transactions.push({
              date: date.trim(),
              desc: desc.trim(),
              category: category.trim(),
              amount: parseFloat(amount),
              type: type.trim().toLowerCase()
            });
          }
        }
      });
      refreshAfterImport();
    };
    reader.readAsText(file);
  } else if (ext === "xlsx") {
    reader.onload = (evt) => {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });

      sheet.slice(1).forEach(row => {
        if (row.length >= 5) {
          const [date, desc, category, amount, type] = row;
          if (date && amount && type) {
            transactions.push({
              date: date.toString().trim(),
              desc: desc.toString().trim(),
              category: category.toString().trim(),
              amount: parseFloat(amount),
              type: type.toString().toLowerCase()
            });
          }
        }
      });
      refreshAfterImport();
    };
    reader.readAsArrayBuffer(file);
  } else {
    showExportFeedback("Unsupported file type. Use CSV or XLSX.");
  }
});

// Helper after import
function refreshAfterImport() {
  renderTransactions();
  updateSummary();
  autoPopulateBalanceSheet();
  autoPopulateTrialBalance();
  updateCharts();
  renderAssetLifecycle();
  showExportFeedback("Transactions imported!", true);
}

  // =========================
  // Export Helpers
  // =========================
  function extractTableData(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return [];
    const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());
    const rows = [headers];
    const body = table.querySelector("tbody");
    if (!body) return rows;
    body.querySelectorAll("tr").forEach(tr => {
      const cells = Array.from(tr.querySelectorAll("td")).map(td => td.textContent.trim());
      if (cells.length === headers.length) rows.push(cells);
    });
    return rows;
  }

  function showExportFeedback(message, success = false) {
    feedback.textContent = message;
    feedback.classList.remove("hidden");
    feedback.style.opacity = "1";
    feedback.classList.toggle("bg-green-600", success);
    feedback.classList.toggle("bg-primary-600", !success);
    setTimeout(() => {
      feedback.style.opacity = "0";
      setTimeout(() => feedback.classList.add("hidden"), 500);
    }, 2000);
  }

  // =========================
  // Export CSV
  // =========================
  document.getElementById("exportCSV").addEventListener("click", () => {
    const sections = [
      { id: "transactionTable", title: "Transactions" },
      { id: "trialBalanceTable", title: "Trial Balance" },
      { id: "balanceSheetTable", title: "Balance Sheet" },
      { id: "assetLifecycleTable", title: "Asset Lifecycle" }
    ];

    const csvRows = [];
    sections.forEach(section => {
      const data = extractTableData(section.id);
      if (data.length > 1) {
        csvRows.push([section.title]);
        csvRows.push(...data);
        csvRows.push([""]);
      }
    });

    if (!csvRows.length) return showExportFeedback("No data to export.");
    const csvContent = csvRows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "finance-report.csv";
    link.click();
    showExportFeedback("CSV downloaded!", true);
  });

  // =========================
  // Export Excel
  // =========================
  document.getElementById("exportExcel").addEventListener("click", () => {
    const workbook = XLSX.utils.book_new();
    const sections = [
      { id: "transactionTable", title: "Transactions" },
      { id: "trialBalanceTable", title: "Trial Balance" },
      { id: "balanceSheetTable", title: "Balance Sheet" },
      { id: "assetLifecycleTable", title: "Asset Lifecycle" }
    ];
    let hasData = false;
    sections.forEach(section => {
      const data = extractTableData(section.id);
      if (data.length > 1) {
        const sheet = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(workbook, sheet, section.title);
        hasData = true;
      }
    });
    if (!hasData) return showExportFeedback("No data to export.");
    XLSX.writeFile(workbook, "finance-report.xlsx");
    showExportFeedback("Excel file downloaded!", true);
  });

  // =========================
  // Export PDF
  // =========================
  document.getElementById("exportPDF").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    doc.setFontSize(14);
    doc.text("Finance Report", 14, y);
    y += 10;
    showExportFeedback("Generating PDF...");

    const sections = [
      { id: "transactionTable", title: "Transactions" },
      { id: "trialBalanceTable", title: "Trial Balance" },
      { id: "balanceSheetTable", title: "Balance Sheet" },
      { id: "assetLifecycleTable", title: "Asset Lifecycle" }
    ];

    sections.forEach(section => {
      const data = extractTableData(section.id);
      if (data.length > 1) {
        doc.setFontSize(12);
        doc.text(section.title, 14, y);
        y += 5;
        doc.autoTable({
          startY: y,
          head: [data[0]],
          body: data.slice(1),
          theme: "grid",
          styles: { fontSize: 10, cellPadding: 4 }
        });
        y = doc.lastAutoTable.finalY + 10;
        if (y > 260) { doc.addPage(); y = 20; }
      }
    });

    doc.setFontSize(10);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, y);
    doc.save("finance-report.pdf");
    showExportFeedback("PDF downloaded!", true);
  });

  // =========================
  // Init
  // =========================
  initCharts();
});
</script>
</body>
</html>


